!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/common"),require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("ngx-uploadx",["exports","@angular/core","@angular/common","rxjs","rxjs/operators"],e):e((t=t||self)["ngx-uploadx"]={},t.ng.core,t.ng.common,t.rxjs,t.rxjs.operators)}(this,function(t,e,n,s,i){"use strict";var r=function(){return(r=Object.assign||function(t){for(var e,n=1,s=arguments.length;n<s;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function o(t,e,n,s){var i,r=arguments.length,o=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,n,s);else for(var u=t.length-1;u>=0;u--)(i=t[u])&&(o=(r<3?i(o):r>3?i(e,n,o):i(e,n))||o);return r>3&&o&&Object.defineProperty(e,n,o),o}function u(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function a(t,e,n,s){return new(n||(n=Promise))(function(i,r){function o(t){try{a(s.next(t))}catch(e){r(e)}}function u(t){try{a(s["throw"](t))}catch(e){r(e)}}function a(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(o,u)}a((s=s.apply(t,e||[])).next())})}function p(t,e){var n,s,i,r,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:u(0),"throw":u(1),"return":u(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function u(r){return function(u){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,s&&(i=2&r[0]?s["return"]:r[0]?s["throw"]||((i=s["return"])&&i.call(s),0):s.next)&&!(i=i.call(s,r[1])).done)return i;switch(s=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return o.label++,{value:r[1],done:!1};case 5:o.label++,s=r[1],r=[0];continue;case 7:r=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===r[0]||2===r[0])){o=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){o.label=r[1];break}if(6===r[0]&&o.label<i[1]){o.label=i[1],i=r;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(r);break}i[2]&&o.ops.pop(),o.trys.pop();continue}r=e.call(t,o)}catch(u){r=[6,u],s=0}finally{n=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,u])}}}var h=function(){return function(){}}();var c=function(){function t(t,e,n){void 0===t&&(t=200),void 0===e&&(e=300*t),void 0===n&&(n=2),this.min=t,this.max=e,this.k=n,this.code=-1,this.retryAttempts=1,this.delay=this.min}return t.prototype.wait=function(t){var e=this;return new Promise(function(n){t===e.code?(e.retryAttempts++,e.delay=Math.min(e.delay*e.k,e.max)):(e.delay=e.min,e.retryAttempts=1),e.code=t,setTimeout(function(){return n(e.retryAttempts)},e.delay+Math.floor(Math.random()*e.min))})},t.prototype.reset=function(){this.delay=this.min,this.retryAttempts=1,this.code=-1},t}(),l=function(){},d=function(){function t(t,e){this.file=t,this.options=e,this.retry=new c,this.chunkSize=1048576,this.maxRetryAttempts=3,this.uploadId=Math.random().toString(36).substring(2,15),this.name=t.name,this.size=t.size,this.mimeType=t.type||"application/octet-stream",this.stateChange=e.stateChange||l,this.configure(e)}return Object.defineProperty(t.prototype,"status",{get:function(){return this._status},set:function(t){"cancelled"===this._status||"complete"===this._status&&"cancelled"!==t||t!==this._status&&(!this._xhr_||"cancelled"!==t&&"paused"!==t||this._xhr_.abort(),"cancelled"===t&&this.URI&&this.request("delete"),this._status=t,this.notifyState())},enumerable:!0,configurable:!0}),t.prototype.configure=function(t){void 0===t&&(t={});var e=t.metadata,n=t.headers,s=t.token,i=t.endpoint;this.metadata=r({name:this.name,mimeType:this.mimeType,size:this.file.size,lastModified:this.file.lastModified},m(e||this.metadata,this.file)),this.endpoint=i||this.options.endpoint,this.chunkSize=this.options.chunkSize||this.chunkSize,this.maxRetryAttempts=this.options.maxRetryAttempts||this.maxRetryAttempts,this.refreshToken(s),this.headers=r({},this.headers,m(n,this.file))},t.prototype.notifyState=function(){var t={file:this.file,name:this.name,progress:this.progress,percentage:this.progress,remaining:this.remaining,response:this.response,responseStatus:this.responseStatus,size:this.size,speed:this.speed,status:this._status,uploadId:this.uploadId,URI:this.URI};this.stateChange(t)},t.prototype.processResponse=function(t){this.responseStatus=t.status,this.response=y(t),this.statusType=t.status-t.status%100},t.prototype.refreshToken=function(t){this.token=t||this.token,this._token=m(this.token)},t.prototype.maxAttemptsReached=function(){if(this.retry.retryAttempts===this.maxRetryAttempts&&400===this.statusType)return this.retry.reset(),console.error("Error: Maximum number of retry attempts reached:\n          file: "+this.name+",\n          statusCode: "+this.responseStatus),!0},t.prototype.create=function(){var t=this;return new Promise(function(e,n){if(t.URI&&404!==t.responseStatus)e();else{var s=new XMLHttpRequest;s.open(t.options.method.toUpperCase(),t.endpoint,!0),t.setupXHR(s),s.setRequestHeader("Content-Type","application/json; charset=UTF-8"),s.setRequestHeader("X-Upload-Content-Length",t.size.toString()),s.setRequestHeader("X-Upload-Content-Type",t.mimeType),s.onload=function(){t.processResponse(s);var i=200===t.statusType&&f(s,"location");i?(t.URI=function(t,e){if(t.indexOf("//")*t.indexOf("https://")*t.indexOf("http://")==0)return t;try{return new URL(t,e).href}catch(s){var n;return 0===t.indexOf("/")?((n=e.match(/^(?:https?:)?(?:\/\/)?([^\/\?]+)/g))&&n[0])+t:((n=e.match(/^(?:https?:)?(?:\/\/)?([^\/\?]+)?(.*\/)/g))&&n[0])+t}}(i,t.endpoint),t.retry.reset(),e()):(t.statusType=400,n())},s.onerror=function(){return n()},s.send(JSON.stringify(t.metadata))}})},t.prototype.upload=function(t){return a(this,void 0,void 0,function(){return p(this,function(e){switch(e.label){case 0:if(t&&this.configure(t),"cancelled"===this._status||"complete"===this._status||"paused"===this._status)return[2];this.status="uploading",this.refreshToken(),e.label=1;case 1:return e.trys.push([1,3,,7]),[4,this.create()];case 2:return e.sent(),this.startTime=(new Date).getTime(),this.sendChunk(this.progress?undefined:0),[3,7];case 3:return e.sent(),this.maxAttemptsReached()?(this.status="error",[3,6]):[3,4];case 4:return this.status="retry",[4,this.retry.wait(this.responseStatus)];case 5:e.sent(),this.status="queue",e.label=6;case 6:return[3,7];case 7:return[2]}})})},t.prototype.sendChunk=function(t){if("uploading"===this.status){var e=null,n=new XMLHttpRequest;if(n.open("PUT",this.URI,!0),this.setupXHR(n),this.setupEvents(n),t>=0&&t<this.size){var s=this.chunkSize?Math.min(t+this.chunkSize,this.size):this.size;e=this.file.slice(t,s),n.upload.onprogress=this.setupProgressEvent(t,s),n.setRequestHeader("Content-Range","bytes "+t+"-"+(s-1)+"/"+this.size),n.setRequestHeader("Content-Type","application/octet-stream")}else n.setRequestHeader("Content-Range","bytes */"+this.size);n.send(e)}},t.prototype.setupEvents=function(t){var e=this,n=function(){return a(e,void 0,void 0,function(){return p(this,function(e){switch(e.label){case 0:return this.maxAttemptsReached()?(this.status="error",[2]):(this.status="retry",[4,this.retry.wait(t.status)]);case 1:return e.sent(),404===t.status?(this.status="queue",[2]):(413===t.status&&(this.chunkSize/=2),this.refreshToken(),this.status="uploading",this.sendChunk(),[2])}})})};t.onerror=n,t.onload=function(){e.processResponse(t);var s=300===e.statusType&&e.getNextChunkOffset(t);"number"==typeof s?(e.retry.reset(),e.sendChunk(s)):200===e.statusType?(e.progress=100,e.status="complete"):n()}},t.prototype.setupProgressEvent=function(t,e){var n=this;return function(s){var i=s.lengthComputable?t+(e-t)*(s.loaded/s.total):t;n.progress=+(i/n.size*100).toFixed(2);var r=(new Date).getTime();n.speed=Math.round(i/(r-n.startTime)*1e3),n.remaining=Math.ceil((n.size-i)/n.speed),n.notifyState()}},t.prototype.getNextChunkOffset=function(t){var e=f(t,"Range"),n=function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var s,i,r=n.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(u){i={error:u}}finally{try{s&&!s.done&&(n=r["return"])&&n.call(r)}finally{if(i)throw i.error}}return o}(e&&e.match(/(-1|\d+)$/g),1)[0];return n&&+n+1},t.prototype.setupXHR=function(t){var e=this;this.responseStatus=null,this.response=null,this.statusType=null,this._xhr_=t,t.responseType="json",t.withCredentials=this.options.withCredentials,Object.keys(this.headers).forEach(function(n){return t.setRequestHeader(n,e.headers[n])}),this._token&&t.setRequestHeader("Authorization","Bearer "+this._token)},t.prototype.request=function(t,e){var n=this;return void 0===e&&(e=null),new Promise(function(s,i){var r=new XMLHttpRequest;r.open(t.toUpperCase(),n.URI,!0),n.setupXHR(r),r.onload=function(){n.processResponse(r),s()},r.onerror=function(){return i()};var o=e?JSON.stringify(e):null;r.send(o)})},t}();function f(t,e){var n=t.getResponseHeader(e);if(n)return n;var s=y(t)||{};return s[Object.keys(s).find(function(t){return t.toLowerCase()===e.toLowerCase()})]}function y(t){return"object"==typeof t.response?t.response:JSON.parse(t.responseText||null)}function m(t,e){return t instanceof Function?t(e):t}var v=function(){function t(){var t=this;this.eventsStream=new s.Subject,this.queue=[],this.concurrency=2,this.autoUpload=!0,this.stateChange=function(e){setTimeout(function(){t.eventsStream.next(e)})},this.events.subscribe(function(e){"uploading"!==e.status&&"added"!==e.status&&t.processQueue()})}return Object.defineProperty(t.prototype,"events",{get:function(){return this.eventsStream.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"uploaderOptions",{get:function(){return{method:this.options.method||"POST",endpoint:this.options.endpoint||this.options.url||"/upload",headers:this.options.headers,metadata:this.options.metadata,token:this.options.token,chunkSize:this.options.chunkSize,withCredentials:this.options.withCredentials,maxRetryAttempts:this.options.maxRetryAttempts,stateChange:this.stateChange}},enumerable:!0,configurable:!0}),t.prototype.init=function(t){return this.options=t,this.concurrency=t.concurrency||this.concurrency,this.autoUpload=!(!1===t.autoUpload),this.events},t.prototype.connect=function(t){var e=this;return this.init(t||this.options).pipe(i.startWith(0),i.map(function(){return e.queue}))},t.prototype.disconnect=function(){this.queue.forEach(function(t){return t.status="paused"}),this.queue=[]},t.prototype.handleFileList=function(t){for(var e=0;e<t.length;e++){var n=new d(t.item(e),this.uploaderOptions);this.queue.push(n),n.status="added"}this.autoUploadFiles()},t.prototype.handleFile=function(t){var e=new d(t,this.uploaderOptions);this.queue.push(e),e.status="added",this.autoUploadFiles()},t.prototype.autoUploadFiles=function(){this.autoUpload&&this.queue.filter(function(t){return"added"===t.status}).forEach(function(t){return t.status="queue"})},t.prototype.control=function(t){switch(t.action){case"cancelAll":this.queue.forEach(function(t){return t.status="cancelled"});break;case"pauseAll":this.queue.forEach(function(t){return t.status="paused"});break;case"refreshToken":this.queue.forEach(function(e){return e.refreshToken(t.token)});break;case"uploadAll":this.queue.filter(function(t){return"uploading"!==t.status}).forEach(function(t){return t.status="queue"});break;case"upload":var e=t.uploadId||t.itemOptions.uploadId,n=this.queue.find(function(t){return t.uploadId===e});n.configure(t.itemOptions),n.status="queue";break;case"cancel":this.queue.find(function(e){return e.uploadId===t.uploadId}).status="cancelled";break;case"pause":this.queue.find(function(e){return e.uploadId===t.uploadId}).status="paused"}},t.prototype.processQueue=function(){this.queue=this.queue.filter(function(t){return"cancelled"!==t.status});var t=this.runningProcess();this.queue.filter(function(t){return"queue"===t.status}).slice(0,Math.max(this.concurrency-t,0)).forEach(function(t){t.upload()})},t.prototype.runningProcess=function(){return this.queue.filter(function(t){return"uploading"===t.status||"retry"===t.status}).length},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t=o([e.Injectable({providedIn:"root"}),u("design:paramtypes",[])],t)}(),g=function(){function t(t,n,s){var i=this;this.elementRef=t,this.renderer=n,this.uploadService=s,this.uploadxState=new e.EventEmitter,this.fileListener=function(){i.elementRef.nativeElement.files&&i.uploadService.handleFileList(i.elementRef.nativeElement.files)}}return Object.defineProperty(t.prototype,"uploadxAction",{set:function(t){t&&this.uploadService&&this.uploadService.control(t)},enumerable:!0,configurable:!0}),t.prototype.ngOnInit=function(){this.uploadx&&(this.uploadx.allowedTypes&&this.renderer.setAttribute(this.elementRef.nativeElement,"accept",this.uploadx.allowedTypes),this.uploadService.init(this.uploadx)),this.uploadxState.emit(this.uploadService.events),this.listenerFn=this.renderer.listen(this.elementRef.nativeElement,"change",this.fileListener)},t.prototype.ngOnDestroy=function(){this.listenerFn&&this.listenerFn()},o([e.Output(),u("design:type",Object)],t.prototype,"uploadxState",void 0),o([e.Input(),u("design:type",h)],t.prototype,"uploadx",void 0),o([e.Input(),u("design:type",Object),u("design:paramtypes",[Object])],t.prototype,"uploadxAction",null),t=o([e.Directive({selector:"[uploadx]"}),u("design:paramtypes",[e.ElementRef,e.Renderer2,v])],t)}(),b=function(){function t(){}return t=o([e.NgModule({imports:[n.CommonModule],declarations:[g],exports:[g]})],t)}();t.Uploader=d,t.UploadxModule=b,t.UploadxOptions=h,t.UploadxService=v,t.ɵa=g,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ngx-uploadx.umd.min.js.map