/**
 * Implements XHR/CORS Resumable Upload
 * @see
 * https://developers.google.com/drive/v3/web/resumable-upload
 */
import * as tslib_1 from "tslib";
import { resolveUrl } from './resolve_url';
import { BackoffRetry } from './backoff_retry';
const noop = () => { };
const ɵ0 = noop;
export class Uploader {
    /**
     * Creates an instance of Uploader.
     */
    constructor(file, options) {
        this.file = file;
        this.options = options;
        this.retry = new BackoffRetry();
        this.chunkSize = 1048576;
        this.maxRetryAttempts = 3;
        this.uploadId = Math.random()
            .toString(36)
            .substring(2, 15);
        this.name = file.name;
        this.size = file.size;
        this.mimeType = file.type || 'application/octet-stream';
        this.stateChange = options.stateChange || noop;
        this.configure(options);
    }
    set status(s) {
        // Return if State is cancelled or complete (but allow cancel of an complete upload to remove from list and from server)
        if (this._status === 'cancelled' || (this._status === 'complete' && s !== 'cancelled')) {
            return;
        }
        if (s !== this._status) {
            if (this._xhr_ && (s === 'cancelled' || s === 'paused')) {
                this._xhr_.abort();
            }
            if (s === 'cancelled' && this.URI) {
                this.request('delete');
            }
            this._status = s;
            this.notifyState();
        }
    }
    get status() {
        return this._status;
    }
    /**
     * configure or reconfigure uploader
     */
    configure(item = {}) {
        const { metadata, headers, token, endpoint } = item;
        this.metadata = Object.assign({ name: this.name, mimeType: this.mimeType, size: this.file.size, lastModified: this.file.lastModified }, unfunc(metadata || this.metadata, this.file));
        this.endpoint = endpoint || this.options.endpoint;
        this.chunkSize = this.options.chunkSize || this.chunkSize;
        this.maxRetryAttempts = this.options.maxRetryAttempts || this.maxRetryAttempts;
        this.refreshToken(token);
        this.headers = Object.assign({}, this.headers, unfunc(headers, this.file));
    }
    /**
     * Emit current state
     */
    notifyState() {
        const state = {
            file: this.file,
            name: this.name,
            progress: this.progress,
            percentage: this.progress,
            remaining: this.remaining,
            response: this.response,
            responseStatus: this.responseStatus,
            size: this.size,
            speed: this.speed,
            status: this._status,
            uploadId: this.uploadId,
            URI: this.URI
        };
        this.stateChange(state);
    }
    processResponse(xhr) {
        this.responseStatus = xhr.status;
        this.response = parseJson(xhr);
        this.statusType = xhr.status - (xhr.status % 100);
    }
    refreshToken(token) {
        this.token = token || this.token;
        this._token = unfunc(this.token);
    }
    maxAttemptsReached() {
        if (this.retry.retryAttempts === this.maxRetryAttempts && this.statusType === 400) {
            this.retry.reset();
            console.error(`Error: Maximum number of retry attempts reached:
          file: ${this.name},
          statusCode: ${this.responseStatus}`);
            return true;
        }
    }
    create() {
        return new Promise((resolve, reject) => {
            if (!this.URI || this.responseStatus === 404) {
                // get file URI
                const xhr = new XMLHttpRequest();
                xhr.open(this.options.method.toUpperCase(), this.endpoint, true);
                this.setupXHR(xhr);
                xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
                xhr.setRequestHeader('X-Upload-Content-Length', this.size.toString());
                xhr.setRequestHeader('X-Upload-Content-Type', this.mimeType);
                xhr.onload = () => {
                    this.processResponse(xhr);
                    const location = this.statusType === 200 && getKeyFromResponse(xhr, 'location');
                    if (!location) {
                        // limit attempts
                        this.statusType = 400;
                        reject();
                    }
                    else {
                        this.URI = resolveUrl(location, this.endpoint);
                        this.retry.reset();
                        resolve();
                    }
                };
                xhr.onerror = () => reject();
                xhr.send(JSON.stringify(this.metadata));
            }
            else {
                resolve();
            }
        });
    }
    /**
     * Initiate upload
     */
    upload(item) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (item)
                this.configure(item);
            if (this._status === 'cancelled' || this._status === 'complete' || this._status === 'paused') {
                return;
            }
            this.status = 'uploading';
            this.refreshToken();
            try {
                yield this.create();
                this.startTime = new Date().getTime();
                this.sendChunk(this.progress ? undefined : 0);
            }
            catch (e) {
                if (this.maxAttemptsReached()) {
                    this.status = 'error';
                }
                else {
                    this.status = 'retry';
                    yield this.retry.wait(this.responseStatus);
                    this.status = 'queue';
                }
            }
        });
    }
    /**
     * Chunk upload +/ get offset
     */
    sendChunk(offset) {
        if (this.status === 'uploading') {
            let body = null;
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', this.URI, true);
            this.setupXHR(xhr);
            this.setupEvents(xhr);
            if (offset >= 0 && offset < this.size) {
                const end = this.chunkSize ? Math.min(offset + this.chunkSize, this.size) : this.size;
                body = this.file.slice(offset, end);
                xhr.upload.onprogress = this.setupProgressEvent(offset, end);
                xhr.setRequestHeader('Content-Range', `bytes ${offset}-${end - 1}/${this.size}`);
                xhr.setRequestHeader('Content-Type', 'application/octet-stream');
            }
            else {
                xhr.setRequestHeader('Content-Range', `bytes */${this.size}`);
            }
            xhr.send(body);
        }
    }
    setupEvents(xhr) {
        const onError = () => tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (this.maxAttemptsReached()) {
                this.status = 'error';
                return;
            }
            this.status = 'retry';
            yield this.retry.wait(xhr.status);
            if (xhr.status === 404) {
                this.status = 'queue';
                return;
            }
            if (xhr.status === 413) {
                this.chunkSize /= 2;
            }
            this.refreshToken();
            this.status = 'uploading';
            // request offset
            this.sendChunk();
        });
        const onSuccess = () => {
            this.processResponse(xhr);
            const offset = this.statusType === 300 && this.getNextChunkOffset(xhr);
            if (typeof offset === 'number') {
                //  next chunk
                this.retry.reset();
                this.sendChunk(offset);
            }
            else if (this.statusType === 200) {
                this.progress = 100;
                this.status = 'complete';
            }
            else {
                onError();
            }
        };
        xhr.onerror = onError;
        xhr.onload = onSuccess;
    }
    setupProgressEvent(offset, end) {
        return (pEvent) => {
            const uploaded = pEvent.lengthComputable
                ? offset + (end - offset) * (pEvent.loaded / pEvent.total)
                : offset;
            this.progress = +((uploaded / this.size) * 100).toFixed(2);
            const now = new Date().getTime();
            this.speed = Math.round((uploaded / (now - this.startTime)) * 1000);
            this.remaining = Math.ceil((this.size - uploaded) / this.speed);
            this.notifyState();
        };
    }
    getNextChunkOffset(xhr) {
        const str = getKeyFromResponse(xhr, 'Range');
        const [match] = str && str.match(/(-1|\d+)$/g);
        return match && +match + 1;
    }
    setupXHR(xhr) {
        //reset response
        this.responseStatus = null;
        this.response = null;
        this.statusType = null;
        this._xhr_ = xhr;
        xhr.responseType = 'json';
        xhr.withCredentials = this.options.withCredentials;
        Object.keys(this.headers).forEach(key => xhr.setRequestHeader(key, this.headers[key]));
        // tslint:disable-next-line: no-unused-expression
        this._token && xhr.setRequestHeader('Authorization', `Bearer ${this._token}`);
    }
    request(method, payload = null) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open(method.toUpperCase(), this.URI, true);
            this.setupXHR(xhr);
            xhr.onload = () => {
                this.processResponse(xhr);
                resolve();
            };
            xhr.onerror = () => reject();
            const body = payload ? JSON.stringify(payload) : null;
            xhr.send(body);
        });
    }
}
function getKeyFromResponse(xhr, key) {
    const fromHeader = xhr.getResponseHeader(key);
    if (fromHeader) {
        return fromHeader;
    }
    const response = parseJson(xhr) || {};
    const resKey = Object.keys(response).find(k => k.toLowerCase() === key.toLowerCase());
    return response[resKey];
}
function parseJson(xhr) {
    return typeof xhr.response === 'object' ? xhr.response : JSON.parse(xhr.responseText || null);
}
function unfunc(value, file) {
    return value instanceof Function ? value(file) : value;
}
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtdXBsb2FkeC8iLCJzb3VyY2VzIjpbInVwbG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7O0FBRUgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFZL0MsTUFBTSxJQUFJLEdBQUcsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDOztBQUV0QixNQUFNLE9BQU8sUUFBUTtJQThDbkI7O09BRUc7SUFDSCxZQUE2QixJQUFVLEVBQVMsT0FBd0I7UUFBM0MsU0FBSSxHQUFKLElBQUksQ0FBTTtRQUFTLFlBQU8sR0FBUCxPQUFPLENBQWlCO1FBNUNoRSxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQWdCM0IsY0FBUyxHQUFHLE9BQVMsQ0FBQztRQUN0QixxQkFBZ0IsR0FBRyxDQUFDLENBQUM7UUE0QjNCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRTthQUMxQixRQUFRLENBQUMsRUFBRSxDQUFDO2FBQ1osU0FBUyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNwQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksSUFBSSwwQkFBMEIsQ0FBQztRQUN4RCxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDO1FBQy9DLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDMUIsQ0FBQztJQWpDRCxJQUFJLE1BQU0sQ0FBQyxDQUFlO1FBQ3hCLHdIQUF3SDtRQUN4SCxJQUFJLElBQUksQ0FBQyxPQUFP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QU8sS0FBSyxZQUFZLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDekQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogSW1wbGVtZW50cyBYSFIvQ09SUyBSZXN1bWFibGUgVXBsb2FkXG4gKiBAc2VlXG4gKiBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9kcml2ZS92My93ZWIvcmVzdW1hYmxlLXVwbG9hZFxuICovXG5cbmltcG9ydCB7IHJlc29sdmVVcmwgfSBmcm9tICcuL3Jlc29sdmVfdXJsJztcbmltcG9ydCB7IEJhY2tvZmZSZXRyeSB9IGZyb20gJy4vYmFja29mZl9yZXRyeSc7XG5pbXBvcnQgeyBVcGxvYWRTdGF0dXMsIFVwbG9hZEl0ZW0sIFVwbG9hZFN0YXRlIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcblxuLyoqXG4gKlxuICovXG5leHBvcnQgaW50ZXJmYWNlIFVwbG9hZGVyT3B0aW9ucyBleHRlbmRzIFVwbG9hZEl0ZW0ge1xuICBtYXhSZXRyeUF0dGVtcHRzOiBudW1iZXI7XG4gIGNodW5rU2l6ZT86IG51bWJlcjtcbiAgd2l0aENyZWRlbnRpYWxzPzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgc3RhdGVDaGFuZ2U/OiBhbnk7XG59XG5jb25zdCBub29wID0gKCkgPT4ge307XG5cbmV4cG9ydCBjbGFzcyBVcGxvYWRlciB7XG4gIGhlYWRlcnM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gfCBudWxsO1xuICBtZXRhZGF0YTogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbiAgZW5kcG9pbnQ6IHN0cmluZztcbiAgcHJpdmF0ZSBfc3RhdHVzOiBVcGxvYWRTdGF0dXM7XG4gIHByaXZhdGUgcmV0cnkgPSBuZXcgQmFja29mZlJldHJ5KCk7XG4gIHByaXZhdGUgc3RhcnRUaW1lOiBudW1iZXI7XG4gIHByb2dyZXNzOiBudW1iZXI7XG4gIHJlYWRvbmx5IG1pbWVUeXBlOiBzdHJpbmc7XG4gIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbiAgcmVhZG9ubHkgc2l6ZTogbnVtYmVyO1xuICByZWFkb25seSB1cGxvYWRJZDogc3RyaW5nO1xuICByZW1haW5pbmc6IG51bWJlcjtcbiAgcmVzcG9uc2U6IGFueTtcbiAgcmVzcG9uc2VTdGF0dXM6IG51bWJlcjtcbiAgc3BlZWQ6IG51bWJlcjtcbiAgVVJJOiBzdHJpbmc7XG4gIHRva2VuOiBzdHJpbmcgfCAoKCkgPT4gc3RyaW5nKTtcbiAgcHJpdmF0ZSBzdGF0dXNUeXBlOiBudW1iZXI7XG4gIHByaXZhdGUgX3Rva2VuOiBzdHJpbmc7XG4gIHByaXZhdGUgX3hocl86IFhNTEh0dHBSZXF1ZXN0O1xuICBwcml2YXRlIGNodW5rU2l6ZSA9IDFfMDQ4XzU3NjtcbiAgcHJpdmF0ZSBtYXhSZXRyeUF0dGVtcHRzID0gMztcbiAgcHJpdmF0ZSBzdGF0ZUNoYW5nZTogKGV2dDogVXBsb2FkU3RhdGUpID0+IHZvaWQ7XG5cbiAgc2V0IHN0YXR1cyhzOiBVcGxvYWRTdGF0dXMpIHtcbiAgICAvLyBSZXR1cm4gaWYgU3RhdGUgaXMgY2FuY2VsbGVkIG9yIGNvbXBsZXRlIChidXQgYWxsb3cgY2FuY2VsIG9mIGFuIGNvbXBsZXRlIHVwbG9hZCB0byByZW1vdmUgZnJvbSBsaXN0IGFuZCBmcm9tIHNlcnZlcilcbiAgICBpZiAodGhpcy5fc3RhdHVzID09PSAnY2FuY2VsbGVkJyB8fCAodGhpcy5fc3RhdHVzID09PSAnY29tcGxldGUnICYmIHMgIT09ICdjYW5jZWxsZWQnKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAocyAhPT0gdGhpcy5fc3RhdHVzKSB7XG4gICAgICBpZiAodGhpcy5feGhyXyAmJiAocyA9PT0gJ2NhbmNlbGxlZCcgfHwgcyA9PT0gJ3BhdXNlZCcpKSB7XG4gICAgICAgIHRoaXMuX3hocl8uYWJvcnQoKTtcbiAgICAgIH1cbiAgICAgIGlmIChzID09PSAnY2FuY2VsbGVkJyAmJiB0aGlzLlVSSSkge1xuICAgICAgICB0aGlzLnJlcXVlc3QoJ2RlbGV0ZScpO1xuICAgICAgfVxuICAgICAgdGhpcy5fc3RhdHVzID0gcztcbiAgICAgIHRoaXMubm90aWZ5U3RhdGUoKTtcbiAgICB9XG4gIH1cblxuICBnZXQgc3RhdHVzKCkge1xuICAgIHJldHVybiB0aGlzLl9zdGF0dXM7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBVcGxvYWRlci5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgZmlsZTogRmlsZSwgcHVibGljIG9wdGlvbnM6IFVwbG9hZGVyT3B0aW9ucykge1xuICAgIHRoaXMudXBsb2FkSWQgPSBNYXRoLnJhbmRvbSgpXG4gICAgICAudG9TdHJpbmcoMzYpXG4gICAgICAuc3Vic3RyaW5nKDIsIDE1KTtcbiAgICB0aGlzLm5hbWUgPSBmaWxlLm5hbWU7XG4gICAgdGhpcy5zaXplID0gZmlsZS5zaXplO1xuICAgIHRoaXMubWltZVR5cGUgPSBmaWxlLnR5cGUgfHwgJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7XG4gICAgdGhpcy5zdGF0ZUNoYW5nZSA9IG9wdGlvbnMuc3RhdGVDaGFuZ2UgfHwgbm9vcDtcbiAgICB0aGlzLmNvbmZpZ3VyZShvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBjb25maWd1cmUgb3IgcmVjb25maWd1cmUgdXBsb2FkZXJcbiAgICovXG4gIGNvbmZpZ3VyZShpdGVtID0ge30gYXMgVXBsb2FkSXRlbSk6IHZvaWQge1xuICAgIGNvbnN0IHsgbWV0YWRhdGEsIGhlYWRlcnMsIHRva2VuLCBlbmRwb2ludCB9ID0gaXRlbTtcbiAgICB0aGlzLm1ldGFkYXRhID0ge1xuICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgbWltZVR5cGU6IHRoaXMubWltZVR5cGUsXG4gICAgICBzaXplOiB0aGlzLmZpbGUuc2l6ZSxcbiAgICAgIGxhc3RNb2RpZmllZDogdGhpcy5maWxlLmxhc3RNb2RpZmllZCxcbiAgICAgIC4uLnVuZnVuYyhtZXRhZGF0YSB8fCB0aGlzLm1ldGFkYXRhLCB0aGlzLmZpbGUpXG4gICAgfTtcbiAgICB0aGlzLmVuZHBvaW50ID0gZW5kcG9pbnQgfHwgdGhpcy5vcHRpb25zLmVuZHBvaW50O1xuICAgIHRoaXMuY2h1bmtTaXplID0gdGhpcy5vcHRpb25zLmNodW5rU2l6ZSB8fCB0aGlzLmNodW5rU2l6ZTtcbiAgICB0aGlzLm1heFJldHJ5QXR0ZW1wdHMgPSB0aGlzLm9wdGlvbnMubWF4UmV0cnlBdHRlbXB0cyB8fCB0aGlzLm1heFJldHJ5QXR0ZW1wdHM7XG4gICAgdGhpcy5yZWZyZXNoVG9rZW4odG9rZW4pO1xuICAgIHRoaXMuaGVhZGVycyA9IHsgLi4udGhpcy5oZWFkZXJzLCAuLi51bmZ1bmMoaGVhZGVycywgdGhpcy5maWxlKSB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEVtaXQgY3VycmVudCBzdGF0ZVxuICAgKi9cbiAgcHJpdmF0ZSBub3RpZnlTdGF0ZSgpOiB2b2lkIHtcbiAgICBjb25zdCBzdGF0ZTogVXBsb2FkU3RhdGUgPSB7XG4gICAgICBmaWxlOiB0aGlzLmZpbGUsXG4gICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICBwcm9ncmVzczogdGhpcy5wcm9ncmVzcyxcbiAgICAgIHBlcmNlbnRhZ2U6IHRoaXMucHJvZ3Jlc3MsXG4gICAgICByZW1haW5pbmc6IHRoaXMucmVtYWluaW5nLFxuICAgICAgcmVzcG9uc2U6IHRoaXMucmVzcG9uc2UsXG4gICAgICByZXNwb25zZVN0YXR1czogdGhpcy5yZXNwb25zZVN0YXR1cyxcbiAgICAgIHNpemU6IHRoaXMuc2l6ZSxcbiAgICAgIHNwZWVkOiB0aGlzLnNwZWVkLFxuICAgICAgc3RhdHVzOiB0aGlzLl9zdGF0dXMsXG4gICAgICB1cGxvYWRJZDogdGhpcy51cGxvYWRJZCxcbiAgICAgIFVSSTogdGhpcy5VUklcbiAgICB9O1xuICAgIHRoaXMuc3RhdGVDaGFuZ2Uoc3RhdGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBwcm9jZXNzUmVzcG9uc2UoeGhyOiBYTUxIdHRwUmVxdWVzdCk6IHZvaWQge1xuICAgIHRoaXMucmVzcG9uc2VTdGF0dXMgPSB4aHIuc3RhdHVzO1xuICAgIHRoaXMucmVzcG9uc2UgPSBwYXJzZUpzb24oeGhyKTtcbiAgICB0aGlzLnN0YXR1c1R5cGUgPSB4aHIuc3RhdHVzIC0gKHhoci5zdGF0dXMgJSAxMDApO1xuICB9XG5cbiAgcmVmcmVzaFRva2VuKHRva2VuPzogYW55KTogdm9pZCB7XG4gICAgdGhpcy50b2tlbiA9IHRva2VuIHx8IHRoaXMudG9rZW47XG4gICAgdGhpcy5fdG9rZW4gPSB1bmZ1bmModGhpcy50b2tlbik7XG4gIH1cblxuICBwcml2YXRlIG1heEF0dGVtcHRzUmVhY2hlZCgpOiBib29sZWFuIHwgbmV2ZXIge1xuICAgIGlmICh0aGlzLnJldHJ5LnJldHJ5QXR0ZW1wdHMgPT09IHRoaXMubWF4UmV0cnlBdHRlbXB0cyAmJiB0aGlzLnN0YXR1c1R5cGUgPT09IDQwMCkge1xuICAgICAgdGhpcy5yZXRyeS5yZXNldCgpO1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgYEVycm9yOiBNYXhpbXVtIG51bWJlciBvZiByZXRyeSBhdHRlbXB0cyByZWFjaGVkOlxuICAgICAgICAgIGZpbGU6ICR7dGhpcy5uYW1lfSxcbiAgICAgICAgICBzdGF0dXNDb2RlOiAke3RoaXMucmVzcG9uc2VTdGF0dXN9YFxuICAgICAgKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAoIXRoaXMuVVJJIHx8IHRoaXMucmVzcG9uc2VTdGF0dXMgPT09IDQwNCkge1xuICAgICAgICAvLyBnZXQgZmlsZSBVUklcbiAgICAgICAgY29uc3QgeGhyOiBYTUxIdHRwUmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICB4aHIub3Blbih0aGlzLm9wdGlvbnMubWV0aG9kLnRvVXBwZXJDYXNlKCksIHRoaXMuZW5kcG9pbnQsIHRydWUpO1xuICAgICAgICB0aGlzLnNldHVwWEhSKHhocik7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD1VVEYtOCcpO1xuICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1VcGxvYWQtQ29udGVudC1MZW5ndGgnLCB0aGlzLnNpemUudG9TdHJpbmcoKSk7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdYLVVwbG9hZC1Db250ZW50LVR5cGUnLCB0aGlzLm1pbWVUeXBlKTtcbiAgICAgICAgeGhyLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgICB0aGlzLnByb2Nlc3NSZXNwb25zZSh4aHIpO1xuICAgICAgICAgIGNvbnN0IGxvY2F0aW9uID0gdGhpcy5zdGF0dXNUeXBlID09PSAyMDAgJiYgZ2V0S2V5RnJvbVJlc3BvbnNlKHhociwgJ2xvY2F0aW9uJyk7XG4gICAgICAgICAgaWYgKCFsb2NhdGlvbikge1xuICAgICAgICAgICAgLy8gbGltaXQgYXR0ZW1wdHNcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzVHlwZSA9IDQwMDtcbiAgICAgICAgICAgIHJlamVjdCgpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLlVSSSA9IHJlc29sdmVVcmwobG9jYXRpb24sIHRoaXMuZW5kcG9pbnQpO1xuICAgICAgICAgICAgdGhpcy5yZXRyeS5yZXNldCgpO1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgeGhyLm9uZXJyb3IgPSAoKSA9PiByZWplY3QoKTtcbiAgICAgICAgeGhyLnNlbmQoSlNPTi5zdHJpbmdpZnkodGhpcy5tZXRhZGF0YSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYXRlIHVwbG9hZFxuICAgKi9cbiAgYXN5bmMgdXBsb2FkKGl0ZW0/OiBVcGxvYWRJdGVtIHwgdW5kZWZpbmVkKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKGl0ZW0pIHRoaXMuY29uZmlndXJlKGl0ZW0pO1xuICAgIGlmICh0aGlzLl9zdGF0dXMgPT09ICdjYW5jZWxsZWQnIHx8IHRoaXMuX3N0YXR1cyA9PT0gJ2NvbXBsZXRlJyB8fCB0aGlzLl9zdGF0dXMgPT09ICdwYXVzZWQnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuc3RhdHVzID0gJ3VwbG9hZGluZyc7XG4gICAgdGhpcy5yZWZyZXNoVG9rZW4oKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5jcmVhdGUoKTtcbiAgICAgIHRoaXMuc3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICB0aGlzLnNlbmRDaHVuayh0aGlzLnByb2dyZXNzID8gdW5kZWZpbmVkIDogMCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHRoaXMubWF4QXR0ZW1wdHNSZWFjaGVkKCkpIHtcbiAgICAgICAgdGhpcy5zdGF0dXMgPSAnZXJyb3InO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zdGF0dXMgPSAncmV0cnknO1xuICAgICAgICBhd2FpdCB0aGlzLnJldHJ5LndhaXQodGhpcy5yZXNwb25zZVN0YXR1cyk7XG4gICAgICAgIHRoaXMuc3RhdHVzID0gJ3F1ZXVlJztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2h1bmsgdXBsb2FkICsvIGdldCBvZmZzZXRcbiAgICovXG4gIHByaXZhdGUgc2VuZENodW5rKG9mZnNldD86IG51bWJlcik6IHZvaWQge1xuICAgIGlmICh0aGlzLnN0YXR1cyA9PT0gJ3VwbG9hZGluZycpIHtcbiAgICAgIGxldCBib2R5ID0gbnVsbDtcbiAgICAgIGNvbnN0IHhocjogWE1MSHR0cFJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgIHhoci5vcGVuKCdQVVQnLCB0aGlzLlVSSSwgdHJ1ZSk7XG4gICAgICB0aGlzLnNldHVwWEhSKHhocik7XG4gICAgICB0aGlzLnNldHVwRXZlbnRzKHhocik7XG4gICAgICBpZiAob2Zmc2V0ID49IDAgJiYgb2Zmc2V0IDwgdGhpcy5zaXplKSB7XG4gICAgICAgIGNvbnN0IGVuZCA9IHRoaXMuY2h1bmtTaXplID8gTWF0aC5taW4ob2Zmc2V0ICsgdGhpcy5jaHVua1NpemUsIHRoaXMuc2l6ZSkgOiB0aGlzLnNpemU7XG4gICAgICAgIGJvZHkgPSB0aGlzLmZpbGUuc2xpY2Uob2Zmc2V0LCBlbmQpO1xuICAgICAgICB4aHIudXBsb2FkLm9ucHJvZ3Jlc3MgPSB0aGlzLnNldHVwUHJvZ3Jlc3NFdmVudChvZmZzZXQsIGVuZCk7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVJhbmdlJywgYGJ5dGVzICR7b2Zmc2V0fS0ke2VuZCAtIDF9LyR7dGhpcy5zaXplfWApO1xuICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtUmFuZ2UnLCBgYnl0ZXMgKi8ke3RoaXMuc2l6ZX1gKTtcbiAgICAgIH1cbiAgICAgIHhoci5zZW5kKGJvZHkpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0dXBFdmVudHMoeGhyOiBYTUxIdHRwUmVxdWVzdCk6IHZvaWQge1xuICAgIGNvbnN0IG9uRXJyb3IgPSBhc3luYyAoKSA9PiB7XG4gICAgICBpZiAodGhpcy5tYXhBdHRlbXB0c1JlYWNoZWQoKSkge1xuICAgICAgICB0aGlzLnN0YXR1cyA9ICdlcnJvcic7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMuc3RhdHVzID0gJ3JldHJ5JztcbiAgICAgIGF3YWl0IHRoaXMucmV0cnkud2FpdCh4aHIuc3RhdHVzKTtcbiAgICAgIGlmICh4aHIuc3RhdHVzID09PSA0MDQpIHtcbiAgICAgICAgdGhpcy5zdGF0dXMgPSAncXVldWUnO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoeGhyLnN0YXR1cyA9PT0gNDEzKSB7XG4gICAgICAgIHRoaXMuY2h1bmtTaXplIC89IDI7XG4gICAgICB9XG4gICAgICB0aGlzLnJlZnJlc2hUb2tlbigpO1xuICAgICAgdGhpcy5zdGF0dXMgPSAndXBsb2FkaW5nJztcbiAgICAgIC8vIHJlcXVlc3Qgb2Zmc2V0XG4gICAgICB0aGlzLnNlbmRDaHVuaygpO1xuICAgIH07XG4gICAgY29uc3Qgb25TdWNjZXNzID0gKCkgPT4ge1xuICAgICAgdGhpcy5wcm9jZXNzUmVzcG9uc2UoeGhyKTtcbiAgICAgIGNvbnN0IG9mZnNldCA9IHRoaXMuc3RhdHVzVHlwZSA9PT0gMzAwICYmIHRoaXMuZ2V0TmV4dENodW5rT2Zmc2V0KHhocik7XG4gICAgICBpZiAodHlwZW9mIG9mZnNldCA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgLy8gIG5leHQgY2h1bmtcbiAgICAgICAgdGhpcy5yZXRyeS5yZXNldCgpO1xuICAgICAgICB0aGlzLnNlbmRDaHVuayhvZmZzZXQpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXR1c1R5cGUgPT09IDIwMCkge1xuICAgICAgICB0aGlzLnByb2dyZXNzID0gMTAwO1xuICAgICAgICB0aGlzLnN0YXR1cyA9ICdjb21wbGV0ZSc7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvbkVycm9yKCk7XG4gICAgICB9XG4gICAgfTtcbiAgICB4aHIub25lcnJvciA9IG9uRXJyb3I7XG4gICAgeGhyLm9ubG9hZCA9IG9uU3VjY2VzcztcbiAgfVxuXG4gIHByaXZhdGUgc2V0dXBQcm9ncmVzc0V2ZW50KG9mZnNldDogbnVtYmVyLCBlbmQ6IG51bWJlcikge1xuICAgIHJldHVybiAocEV2ZW50OiBQcm9ncmVzc0V2ZW50KSA9PiB7XG4gICAgICBjb25zdCB1cGxvYWRlZCA9IHBFdmVudC5sZW5ndGhDb21wdXRhYmxlXG4gICAgICAgID8gb2Zmc2V0ICsgKGVuZCAtIG9mZnNldCkgKiAocEV2ZW50LmxvYWRlZCAvIHBFdmVudC50b3RhbClcbiAgICAgICAgOiBvZmZzZXQ7XG4gICAgICB0aGlzLnByb2dyZXNzID0gKygodXBsb2FkZWQgLyB0aGlzLnNpemUpICogMTAwKS50b0ZpeGVkKDIpO1xuICAgICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICB0aGlzLnNwZWVkID0gTWF0aC5yb3VuZCgodXBsb2FkZWQgLyAobm93IC0gdGhpcy5zdGFydFRpbWUpKSAqIDEwMDApO1xuICAgICAgdGhpcy5yZW1haW5pbmcgPSBNYXRoLmNlaWwoKHRoaXMuc2l6ZSAtIHVwbG9hZGVkKSAvIHRoaXMuc3BlZWQpO1xuICAgICAgdGhpcy5ub3RpZnlTdGF0ZSgpO1xuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGdldE5leHRDaHVua09mZnNldCh4aHI6IFhNTEh0dHBSZXF1ZXN0KSB7XG4gICAgY29uc3Qgc3RyID0gZ2V0S2V5RnJvbVJlc3BvbnNlKHhociwgJ1JhbmdlJyk7XG4gICAgY29uc3QgW21hdGNoXSA9IHN0ciAmJiBzdHIubWF0Y2goLygtMXxcXGQrKSQvZyk7XG4gICAgcmV0dXJuIG1hdGNoICYmICttYXRjaCArIDE7XG4gIH1cblxuICBwcml2YXRlIHNldHVwWEhSKHhocjogWE1MSHR0cFJlcXVlc3QpIHtcbiAgICAvL3Jlc2V0IHJlc3BvbnNlXG4gICAgdGhpcy5yZXNwb25zZVN0YXR1cyA9IG51bGw7XG4gICAgdGhpcy5yZXNwb25zZSA9IG51bGw7XG4gICAgdGhpcy5zdGF0dXNUeXBlID0gbnVsbDtcblxuICAgIHRoaXMuX3hocl8gPSB4aHI7XG5cbiAgICB4aHIucmVzcG9uc2VUeXBlID0gJ2pzb24nO1xuICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0aGlzLm9wdGlvbnMud2l0aENyZWRlbnRpYWxzO1xuICAgIE9iamVjdC5rZXlzKHRoaXMuaGVhZGVycykuZm9yRWFjaChrZXkgPT4geGhyLnNldFJlcXVlc3RIZWFkZXIoa2V5LCB0aGlzLmhlYWRlcnNba2V5XSkpO1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tdW51c2VkLWV4cHJlc3Npb25cbiAgICB0aGlzLl90b2tlbiAmJiB4aHIuc2V0UmVxdWVzdEhlYWRlcignQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHt0aGlzLl90b2tlbn1gKTtcbiAgfVxuXG4gIHJlcXVlc3QobWV0aG9kOiBzdHJpbmcsIHBheWxvYWQgPSBudWxsKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IHhocjogWE1MSHR0cFJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgIHhoci5vcGVuKG1ldGhvZC50b1VwcGVyQ2FzZSgpLCB0aGlzLlVSSSwgdHJ1ZSk7XG4gICAgICB0aGlzLnNldHVwWEhSKHhocik7XG4gICAgICB4aHIub25sb2FkID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnByb2Nlc3NSZXNwb25zZSh4aHIpO1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9O1xuICAgICAgeGhyLm9uZXJyb3IgPSAoKSA9PiByZWplY3QoKTtcbiAgICAgIGNvbnN0IGJvZHkgPSBwYXlsb2FkID8gSlNPTi5zdHJpbmdpZnkocGF5bG9hZCkgOiBudWxsO1xuICAgICAgeGhyLnNlbmQoYm9keSk7XG4gICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0S2V5RnJvbVJlc3BvbnNlKHhocjogWE1MSHR0cFJlcXVlc3QsIGtleTogc3RyaW5nKSB7XG4gIGNvbnN0IGZyb21IZWFkZXIgPSB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoa2V5KTtcbiAgaWYgKGZyb21IZWFkZXIpIHtcbiAgICByZXR1cm4gZnJvbUhlYWRlcjtcbiAgfVxuICBjb25zdCByZXNwb25zZSA9IHBhcnNlSnNvbih4aHIpIHx8IHt9O1xuICBjb25zdCByZXNLZXkgPSBPYmplY3Qua2V5cyhyZXNwb25zZSkuZmluZChrID0+IGsudG9Mb3dlckNhc2UoKSA9PT0ga2V5LnRvTG93ZXJDYXNlKCkpO1xuICByZXR1cm4gcmVzcG9uc2VbcmVzS2V5XTtcbn1cblxuZnVuY3Rpb24gcGFyc2VKc29uKHhocjogWE1MSHR0cFJlcXVlc3QpIHtcbiAgcmV0dXJuIHR5cGVvZiB4aHIucmVzcG9uc2UgPT09ICdvYmplY3QnID8geGhyLnJlc3BvbnNlIDogSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0IHx8IG51bGwpO1xufVxuXG5mdW5jdGlvbiB1bmZ1bmM8VD4odmFsdWU6IFQgfCAoKGZpbGU6IEZpbGUpID0+IFQpLCBmaWxlPzogRmlsZSk6IFQge1xuICByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBGdW5jdGlvbiA/IHZhbHVlKGZpbGUpIDogdmFsdWU7XG59XG4iXX0=