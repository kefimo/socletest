import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { Uploader } from './uploader';
import { map, startWith } from 'rxjs/operators';
import * as i0 from "@angular/core";
let UploadxService = class UploadxService {
    constructor() {
        this.eventsStream = new Subject();
        this.queue = [];
        this.concurrency = 2;
        this.autoUpload = true;
        this.stateChange = (evt) => {
            setTimeout(() => {
                this.eventsStream.next(evt);
            });
        };
        this.events.subscribe((evt) => {
            if (evt.status !== 'uploading' && evt.status !== 'added') {
                this.processQueue();
            }
        });
    }
    get events() {
        return this.eventsStream.asObservable();
    }
    get uploaderOptions() {
        return {
            method: this.options.method || 'POST',
            // tslint:disable-next-line: deprecation
            endpoint: this.options.endpoint || this.options.url || '/upload',
            headers: this.options.headers,
            metadata: this.options.metadata,
            token: this.options.token,
            chunkSize: this.options.chunkSize,
            withCredentials: this.options.withCredentials,
            maxRetryAttempts: this.options.maxRetryAttempts,
            stateChange: this.stateChange
        };
    }
    /**
     * Initializes service
     * @param options global options
     * @returns Observable that emits a new value on progress or status changes
     */
    init(options) {
        this.options = options;
        this.concurrency = options.concurrency || this.concurrency;
        this.autoUpload = !(options.autoUpload === false);
        return this.events;
    }
    /**
     * Initializes service
     * @param options global options
     * @returns Observable that emits the current queue
     */
    connect(options) {
        return this.init(options || this.options).pipe(startWith(0), map(() => this.queue));
    }
    /**
     * Terminate all uploads and clears the queue
     */
    disconnect() {
        this.queue.forEach(f => (f.status = 'paused'));
        this.queue = [];
    }
    /**
     * Create Uploader and add to the queue
     */
    handleFileList(fileList) {
        for (let i = 0; i < fileList.length; i++) {
            const uploader = new Uploader(fileList.item(i), this.uploaderOptions);
            this.queue.push(uploader);
            uploader.status = 'added';
        }
        this.autoUploadFiles();
    }
    /**
     * Create Uploader for the file and add to the queue
     */
    handleFile(file) {
        const uploader = new Uploader(file, this.uploaderOptions);
        this.queue.push(uploader);
        uploader.status = 'added';
        this.autoUploadFiles();
    }
    /**
     * Auto upload the files if the flag is true
     * @internal
     */
    autoUploadFiles() {
        if (this.autoUpload) {
            this.queue.filter(f => f.status === 'added').forEach(f => (f.status = 'queue'));
        }
    }
    /**
     * Control uploads status
     * @example
     * this.uploadService.control({ action: 'pauseAll' });
     *
     */
    control(event) {
        switch (event.action) {
            case 'cancelAll':
                this.queue.forEach(f => (f.status = 'cancelled'));
                break;
            case 'pauseAll':
                this.queue.forEach(f => (f.status = 'paused'));
                break;
            case 'refreshToken':
                this.queue.forEach(f => f.refreshToken(event.token));
                break;
            case 'uploadAll':
                this.queue.filter(f => f.status !== 'uploading').forEach(f => (f.status = 'queue'));
                break;
            case 'upload':
                const uploadId = event.uploadId || event.itemOptions.uploadId;
                const upload = this.queue.find(f => f.uploadId === uploadId);
                upload.configure(event.itemOptions);
                upload.status = 'queue';
                break;
            case 'cancel':
                this.queue.find(f => f.uploadId === event.uploadId).status = 'cancelled';
                break;
            case 'pause':
                this.queue.find(f => f.uploadId === event.uploadId).status = 'paused';
                break;
            default:
                break;
        }
    }
    /**
     * Queue management
     * @internal
     */
    processQueue() {
        // Remove Cancelled Items from local queue
        this.queue = this.queue.filter(f => f.status !== 'cancelled');
        const running = this.runningProcess();
        this.queue
            .filter((uploader) => uploader.status === 'queue')
            .slice(0, Math.max(this.concurrency - running, 0))
            .forEach((uploader) => {
            uploader.upload();
        });
    }
    /**
     * @returns  number of active uploads
     */
    runningProcess() {
        return this.queue.filter((uploader) => uploader.status === 'uploading' || uploader.status === 'retry').length;
    }
};
UploadxService.ngInjectableDef = i0.defineInjectable({ factory: function UploadxService_Factory() { return new UploadxService(); }, token: UploadxService, providedIn: "root" });
UploadxService = tslib_1.__decorate([
    Injectable({ providedIn: 'root' }),
    tslib_1.__metadata("design:paramtypes", [])
], UploadxService);
export { UploadxService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkeC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXVwbG9hZHgvIiwic291cmNlcyI6WyJ1cGxvYWR4LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQVEzQyxPQUFPLEVBQUUsUUFBUSxFQUFtQixNQUFNLFlBQVksQ0FBQztBQUN2RCxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOztBQUdoRCxJQUFhLGNBQWMsR0FBM0IsTUFBYSxjQUFjO0lBOEJ6QjtRQTdCaUIsaUJBQVksR0FBeUIsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUlwRSxVQUFLLEdBQWUsRUFBRSxDQUFDO1FBQ2YsZ0JBQVcsR0FBRyxDQUFDLENBQUM7UUFDaEIsZUFBVSxHQUFHLElBQUksQ0FBQztRQUUxQixnQkFBVyxHQUFHLENBQUMsR0FBZ0IsRUFBRSxFQUFFO1lBQ2pDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2QsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDOUIsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUM7UUFrQkEsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFnQixFQUFFLEVBQUU7WUFDekMsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLFdBQVcsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLE9BQU8sRUFBRTtnQkFDeEQsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO2FBQ3JCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBbENELElBQUksTUFBTTtRQUNSLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0lBV0QsSUFBSSxlQUFlO1FB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Q3BCLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUNEOztPQUVHO0lBQ0gsY0FBYztRQUNaLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQ3RCLENBQUMsUUFBa0IsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sS0FBSyxXQUFXLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxPQUFPLENBQ3ZGLENBQUMsTUFBTSxDQUFDO0lBQ1gsQ0FBQztDQUNGLENBQUE7O0FBOUpZLGNBQWM7SUFEMUIsVUFBVSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxDQUFDOztHQUN0QixjQUFjLENBOEoxQjtTQTlKWSxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgVXBsb2FkU3RhdGUsXG4gIFVwbG9hZFN0YXR1cyxcbiAgVXBsb2FkeENvbnRyb2xFdmVudCxcbiAgVXBsb2FkeE9wdGlvbnMsXG4gIFVwbG9hZEV2ZW50XG59IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBVcGxvYWRlciwgVXBsb2FkZXJPcHRpb25zIH0gZnJvbSAnLi91cGxvYWRlcic7XG5pbXBvcnQgeyBtYXAsIHN0YXJ0V2l0aCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBVcGxvYWR4U2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgZXZlbnRzU3RyZWFtOiBTdWJqZWN0PFVwbG9hZFN0YXRlPiA9IG5ldyBTdWJqZWN0KCk7XG4gIGdldCBldmVudHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuZXZlbnRzU3RyZWFtLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG4gIHF1ZXVlOiBVcGxvYWRlcltdID0gW107XG4gIHByaXZhdGUgY29uY3VycmVuY3kgPSAyO1xuICBwcml2YXRlIGF1dG9VcGxvYWQgPSB0cnVlO1xuICBwcml2YXRlIG9wdGlvbnM6IFVwbG9hZHhPcHRpb25zO1xuICBzdGF0ZUNoYW5nZSA9IChldnQ6IFVwbG9hZFN0YXRlKSA9PiB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmV2ZW50c1N0cmVhbS5uZXh0KGV2dCk7XG4gICAgfSk7XG4gIH07XG5cbiAgZ2V0IHVwbG9hZGVyT3B0aW9ucygpOiBVcGxvYWRlck9wdGlvbnMge1xuICAgIHJldHVybiB7XG4gICAgICBtZXRob2Q6IHRoaXMub3B0aW9ucy5tZXRob2QgfHwgJ1BPU1QnLFxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBkZXByZWNhdGlvblxuICAgICAgZW5kcG9pbnQ6IHRoaXMub3B0aW9ucy5lbmRwb2ludCB8fCB0aGlzLm9wdGlvbnMudXJsIHx8ICcvdXBsb2FkJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMub3B0aW9ucy5oZWFkZXJzLFxuICAgICAgbWV0YWRhdGE6IHRoaXMub3B0aW9ucy5tZXRhZGF0YSxcbiAgICAgIHRva2VuOiB0aGlzLm9wdGlvbnMudG9rZW4sXG4gICAgICBjaHVua1NpemU6IHRoaXMub3B0aW9ucy5jaHVua1NpemUsXG4gICAgICB3aXRoQ3JlZGVudGlhbHM6IHRoaXMub3B0aW9ucy53aXRoQ3JlZGVudGlhbHMsXG4gICAgICBtYXhSZXRyeUF0dGVtcHRzOiB0aGlzLm9wdGlvbnMubWF4UmV0cnlBdHRlbXB0cyxcbiAgICAgIHN0YXRlQ2hhbmdlOiB0aGlzLnN0YXRlQ2hhbmdlXG4gICAgfTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuZXZlbnRzLnN1YnNjcmliZSgoZXZ0OiBVcGxvYWRFdmVudCkgPT4ge1xuICAgICAgaWYgKGV2dC5zdGF0dXMgIT09ICd1cGxvYWRpbmcnICYmIGV2dC5zdGF0dXMgIT09ICdhZGRlZCcpIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzUXVldWUoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICAvKipcbiAgICogSW5pdGlhbGl6ZXMgc2VydmljZVxuICAgKiBAcGFyYW0gb3B0aW9ucyBnbG9iYWwgb3B0aW9uc1xuICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIHRoYXQgZW1pdHMgYSBuZXcgdmFsdWUgb24gcHJvZ3Jlc3Mgb3Igc3RhdHVzIGNoYW5nZXNcbiAgICovXG4gIGluaXQob3B0aW9uczogVXBsb2FkeE9wdGlvbnMpOiBPYnNlcnZhYmxlPFVwbG9hZFN0YXRlPiB7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgICB0aGlzLmNvbmN1cnJlbmN5ID0gb3B0aW9ucy5jb25jdXJyZW5jeSB8fCB0aGlzLmNvbmN1cnJlbmN5O1xuICAgIHRoaXMuYXV0b1VwbG9hZCA9ICEob3B0aW9ucy5hdXRvVXBsb2FkID09PSBmYWxzZSk7XG4gICAgcmV0dXJuIHRoaXMuZXZlbnRzO1xuICB9XG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyBzZXJ2aWNlXG4gICAqIEBwYXJhbSBvcHRpb25zIGdsb2JhbCBvcHRpb25zXG4gICAqIEByZXR1cm5zIE9ic2VydmFibGUgdGhhdCBlbWl0cyB0aGUgY3VycmVudCBxdWV1ZVxuICAgKi9cbiAgY29ubmVjdChvcHRpb25zPzogVXBsb2FkeE9wdGlvbnMpOiBPYnNlcnZhYmxlPFVwbG9hZGVyW10+IHtcbiAgICByZXR1cm4gdGhpcy5pbml0KG9wdGlvbnMgfHwgdGhpcy5vcHRpb25zKS5waXBlKFxuICAgICAgc3RhcnRXaXRoKDApLFxuICAgICAgbWFwKCgpID0+IHRoaXMucXVldWUpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUZXJtaW5hdGUgYWxsIHVwbG9hZHMgYW5kIGNsZWFycyB0aGUgcXVldWVcbiAgICovXG4gIGRpc2Nvbm5lY3QoKSB7XG4gICAgdGhpcy5xdWV1ZS5mb3JFYWNoKGYgPT4gKGYuc3RhdHVzID0gJ3BhdXNlZCcpKTtcbiAgICB0aGlzLnF1ZXVlID0gW107XG4gIH1cbiAgLyoqXG4gICAqIENyZWF0ZSBVcGxvYWRlciBhbmQgYWRkIHRvIHRoZSBxdWV1ZVxuICAgKi9cbiAgaGFuZGxlRmlsZUxpc3QoZmlsZUxpc3Q6IEZpbGVMaXN0KSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaWxlTGlzdC5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgdXBsb2FkZXI6IFVwbG9hZGVyID0gbmV3IFVwbG9hZGVyKGZpbGVMaXN0Lml0ZW0oaSksIHRoaXMudXBsb2FkZXJPcHRpb25zKTtcbiAgICAgIHRoaXMucXVldWUucHVzaCh1cGxvYWRlcik7XG4gICAgICB1cGxvYWRlci5zdGF0dXMgPSAnYWRkZWQnO1xuICAgIH1cbiAgICB0aGlzLmF1dG9VcGxvYWRGaWxlcygpO1xuICB9XG4gIC8qKlxuICAgKiBDcmVhdGUgVXBsb2FkZXIgZm9yIHRoZSBmaWxlIGFuZCBhZGQgdG8gdGhlIHF1ZXVlXG4gICAqL1xuICBoYW5kbGVGaWxlKGZpbGU6IEZpbGUpOiB2b2lkIHtcbiAgICBjb25zdCB1cGxvYWRlcjogVXBsb2FkZXIgPSBuZXcgVXBsb2FkZXIoZmlsZSwgdGhpcy51cGxvYWRlck9wdGlvbnMpO1xuICAgIHRoaXMucXVldWUucHVzaCh1cGxvYWRlcik7XG4gICAgdXBsb2FkZXIuc3RhdHVzID0gJ2FkZGVkJztcbiAgICB0aGlzLmF1dG9VcGxvYWRGaWxlcygpO1xuICB9XG4gIC8qKlxuICAgKiBBdXRvIHVwbG9hZCB0aGUgZmlsZXMgaWYgdGhlIGZsYWcgaXMgdHJ1ZVxuICAgKiBAaW50ZXJuYWxcbiAgICovXG4gIHByaXZhdGUgYXV0b1VwbG9hZEZpbGVzKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmF1dG9VcGxvYWQpIHtcbiAgICAgIHRoaXMucXVldWUuZmlsdGVyKGYgPT4gZi5zdGF0dXMgPT09ICdhZGRlZCcpLmZvckVhY2goZiA9PiAoZi5zdGF0dXMgPSAncXVldWUnKSk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiBDb250cm9sIHVwbG9hZHMgc3RhdHVzXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMudXBsb2FkU2VydmljZS5jb250cm9sKHsgYWN0aW9uOiAncGF1c2VBbGwnIH0pO1xuICAgKlxuICAgKi9cbiAgY29udHJvbChldmVudDogVXBsb2FkeENvbnRyb2xFdmVudCk6IHZvaWQge1xuICAgIHN3aXRjaCAoZXZlbnQuYWN0aW9uKSB7XG4gICAgICBjYXNlICdjYW5jZWxBbGwnOlxuICAgICAgICB0aGlzLnF1ZXVlLmZvckVhY2goZiA9PiAoZi5zdGF0dXMgPSAnY2FuY2VsbGVkJykpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3BhdXNlQWxsJzpcbiAgICAgICAgdGhpcy5xdWV1ZS5mb3JFYWNoKGYgPT4gKGYuc3RhdHVzID0gJ3BhdXNlZCcpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdyZWZyZXNoVG9rZW4nOlxuICAgICAgICB0aGlzLnF1ZXVlLmZvckVhY2goZiA9PiBmLnJlZnJlc2hUb2tlbihldmVudC50b2tlbikpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3VwbG9hZEFsbCc6XG4gICAgICAgIHRoaXMucXVldWUuZmlsdGVyKGYgPT4gZi5zdGF0dXMgIT09ICd1cGxvYWRpbmcnKS5mb3JFYWNoKGYgPT4gKGYuc3RhdHVzID0gJ3F1ZXVlJykpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3VwbG9hZCc6XG4gICAgICAgIGNvbnN0IHVwbG9hZElkID0gZXZlbnQudXBsb2FkSWQgfHwgZXZlbnQuaXRlbU9wdGlvbnMudXBsb2FkSWQ7XG4gICAgICAgIGNvbnN0IHVwbG9hZCA9IHRoaXMucXVldWUuZmluZChmID0+IGYudXBsb2FkSWQgPT09IHVwbG9hZElkKTtcbiAgICAgICAgdXBsb2FkLmNvbmZpZ3VyZShldmVudC5pdGVtT3B0aW9ucyk7XG4gICAgICAgIHVwbG9hZC5zdGF0dXMgPSAncXVldWUnIGFzIFVwbG9hZFN0YXR1cztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdjYW5jZWwnOlxuICAgICAgICB0aGlzLnF1ZXVlLmZpbmQoZiA9PiBmLnVwbG9hZElkID09PSBldmVudC51cGxvYWRJZCkuc3RhdHVzID0gJ2NhbmNlbGxlZCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAncGF1c2UnOlxuICAgICAgICB0aGlzLnF1ZXVlLmZpbmQoZiA9PiBmLnVwbG9hZElkID09PSBldmVudC51cGxvYWRJZCkuc3RhdHVzID0gJ3BhdXNlZCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFF1ZXVlIG1hbmFnZW1lbnRcbiAgICogQGludGVybmFsXG4gICAqL1xuICBwcml2YXRlIHByb2Nlc3NRdWV1ZSgpIHtcbiAgICAvLyBSZW1vdmUgQ2FuY2VsbGVkIEl0ZW1zIGZyb20gbG9jYWwgcXVldWVcbiAgICB0aGlzLnF1ZXVlID0gdGhpcy5xdWV1ZS5maWx0ZXIoZiA9PiBmLnN0YXR1cyAhPT0gJ2NhbmNlbGxlZCcpO1xuXG4gICAgY29uc3QgcnVubmluZyA9IHRoaXMucnVubmluZ1Byb2Nlc3MoKTtcblxuICAgIHRoaXMucXVldWVcbiAgICAgIC5maWx0ZXIoKHVwbG9hZGVyOiBVcGxvYWRlcikgPT4gdXBsb2FkZXIuc3RhdHVzID09PSAncXVldWUnKVxuICAgICAgLnNsaWNlKDAsIE1hdGgubWF4KHRoaXMuY29uY3VycmVuY3kgLSBydW5uaW5nLCAwKSlcbiAgICAgIC5mb3JFYWNoKCh1cGxvYWRlcjogVXBsb2FkZXIpID0+IHtcbiAgICAgICAgdXBsb2FkZXIudXBsb2FkKCk7XG4gICAgICB9KTtcbiAgfVxuICAvKipcbiAgICogQHJldHVybnMgIG51bWJlciBvZiBhY3RpdmUgdXBsb2Fkc1xuICAgKi9cbiAgcnVubmluZ1Byb2Nlc3MoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5xdWV1ZS5maWx0ZXIoXG4gICAgICAodXBsb2FkZXI6IFVwbG9hZGVyKSA9PiB1cGxvYWRlci5zdGF0dXMgPT09ICd1cGxvYWRpbmcnIHx8IHVwbG9hZGVyLnN0YXR1cyA9PT0gJ3JldHJ5J1xuICAgICkubGVuZ3RoO1xuICB9XG59XG4iXX0=