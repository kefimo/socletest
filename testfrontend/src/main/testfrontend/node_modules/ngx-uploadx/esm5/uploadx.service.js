import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { Uploader } from './uploader';
import { map, startWith } from 'rxjs/operators';
import * as i0 from "@angular/core";
var UploadxService = /** @class */ (function () {
    function UploadxService() {
        var _this = this;
        this.eventsStream = new Subject();
        this.queue = [];
        this.concurrency = 2;
        this.autoUpload = true;
        this.stateChange = function (evt) {
            setTimeout(function () {
                _this.eventsStream.next(evt);
            });
        };
        this.events.subscribe(function (evt) {
            if (evt.status !== 'uploading' && evt.status !== 'added') {
                _this.processQueue();
            }
        });
    }
    Object.defineProperty(UploadxService.prototype, "events", {
        get: function () {
            return this.eventsStream.asObservable();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(UploadxService.prototype, "uploaderOptions", {
        get: function () {
            return {
                method: this.options.method || 'POST',
                // tslint:disable-next-line: deprecation
                endpoint: this.options.endpoint || this.options.url || '/upload',
                headers: this.options.headers,
                metadata: this.options.metadata,
                token: this.options.token,
                chunkSize: this.options.chunkSize,
                withCredentials: this.options.withCredentials,
                maxRetryAttempts: this.options.maxRetryAttempts,
                stateChange: this.stateChange
            };
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Initializes service
     * @param options global options
     * @returns Observable that emits a new value on progress or status changes
     */
    UploadxService.prototype.init = function (options) {
        this.options = options;
        this.concurrency = options.concurrency || this.concurrency;
        this.autoUpload = !(options.autoUpload === false);
        return this.events;
    };
    /**
     * Initializes service
     * @param options global options
     * @returns Observable that emits the current queue
     */
    UploadxService.prototype.connect = function (options) {
        var _this = this;
        return this.init(options || this.options).pipe(startWith(0), map(function () { return _this.queue; }));
    };
    /**
     * Terminate all uploads and clears the queue
     */
    UploadxService.prototype.disconnect = function () {
        this.queue.forEach(function (f) { return (f.status = 'paused'); });
        this.queue = [];
    };
    /**
     * Create Uploader and add to the queue
     */
    UploadxService.prototype.handleFileList = function (fileList) {
        for (var i = 0; i < fileList.length; i++) {
            var uploader = new Uploader(fileList.item(i), this.uploaderOptions);
            this.queue.push(uploader);
            uploader.status = 'added';
        }
        this.autoUploadFiles();
    };
    /**
     * Create Uploader for the file and add to the queue
     */
    UploadxService.prototype.handleFile = function (file) {
        var uploader = new Uploader(file, this.uploaderOptions);
        this.queue.push(uploader);
        uploader.status = 'added';
        this.autoUploadFiles();
    };
    /**
     * Auto upload the files if the flag is true
     * @internal
     */
    UploadxService.prototype.autoUploadFiles = function () {
        if (this.autoUpload) {
            this.queue.filter(function (f) { return f.status === 'added'; }).forEach(function (f) { return (f.status = 'queue'); });
        }
    };
    /**
     * Control uploads status
     * @example
     * this.uploadService.control({ action: 'pauseAll' });
     *
     */
    UploadxService.prototype.control = function (event) {
        switch (event.action) {
            case 'cancelAll':
                this.queue.forEach(function (f) { return (f.status = 'cancelled'); });
                break;
            case 'pauseAll':
                this.queue.forEach(function (f) { return (f.status = 'paused'); });
                break;
            case 'refreshToken':
                this.queue.forEach(function (f) { return f.refreshToken(event.token); });
                break;
            case 'uploadAll':
                this.queue.filter(function (f) { return f.status !== 'uploading'; }).forEach(function (f) { return (f.status = 'queue'); });
                break;
            case 'upload':
                var uploadId_1 = event.uploadId || event.itemOptions.uploadId;
                var upload = this.queue.find(function (f) { return f.uploadId === uploadId_1; });
                upload.configure(event.itemOptions);
                upload.status = 'queue';
                break;
            case 'cancel':
                this.queue.find(function (f) { return f.uploadId === event.uploadId; }).status = 'cancelled';
                break;
            case 'pause':
                this.queue.find(function (f) { return f.uploadId === event.uploadId; }).status = 'paused';
                break;
            default:
                break;
        }
    };
    /**
     * Queue management
     * @internal
     */
    UploadxService.prototype.processQueue = function () {
        // Remove Cancelled Items from local queue
        this.queue = this.queue.filter(function (f) { return f.status !== 'cancelled'; });
        var running = this.runningProcess();
        this.queue
            .filter(function (uploader) { return uploader.status === 'queue'; })
            .slice(0, Math.max(this.concurrency - running, 0))
            .forEach(function (uploader) {
            uploader.upload();
        });
    };
    /**
     * @returns  number of active uploads
     */
    UploadxService.prototype.runningProcess = function () {
        return this.queue.filter(function (uploader) { return uploader.status === 'uploading' || uploader.status === 'retry'; }).length;
    };
    UploadxService.ngInjectableDef = i0.defineInjectable({ factory: function UploadxService_Factory() { return new UploadxService(); }, token: UploadxService, providedIn: "root" });
    UploadxService = tslib_1.__decorate([
        Injectable({ providedIn: 'root' }),
        tslib_1.__metadata("design:paramtypes", [])
    ], UploadxService);
    return UploadxService;
}());
export { UploadxService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkeC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXVwbG9hZHgvIiwic291cmNlcyI6WyJ1cGxvYWR4LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQVEzQyxPQUFPLEVBQUUsUUFBUSxFQUFtQixNQUFNLFlBQVksQ0FBQztBQUN2RCxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOztBQUdoRDtJQThCRTtRQUFBLGlCQU1DO1FBbkNnQixpQkFBWSxHQUF5QixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBSXBFLFVBQUssR0FBZSxFQUFFLENBQUM7UUFDZixnQkFBVyxHQUFHLENBQUMsQ0FBQztRQUNoQixlQUFVLEdBQUcsSUFBSSxDQUFDO1FBRTFCLGdCQUFXLEdBQUcsVUFBQyxHQUFnQjtZQUM3QixVQUFVLENBQUM7Z0JBQ1QsS0FBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDOUIsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUM7UUFrQkEsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBQyxHQUFnQjtZQUNyQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssV0FBVyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssT0FBTyxFQUFFO2dCQUN4RCxLQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7YUFDckI7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFsQ0Qsc0JBQUksa0NBQU07YUFBVjtZQUNFLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMxQyxDQUFDOzs7T0FBQTtJQVdELHNCQUFJLDJDQUFlO2FBQW5CO1lBQ0UsT0FBTztnQkFDTCxNQUFNLEVBQUUs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QUFBLFFBQVEsQ0FBQyxNQUFNLEtBQUssT0FBTyxFQUEzQixDQUEyQixDQUFDO2FBQzNELEtBQUssQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQzthQUNqRCxPQUFPLENBQUMsVUFBQyxRQUFrQjtZQUMxQixRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0Q7O09BRUc7SUFDSCx1Q0FBYyxHQUFkO1FBQ0UsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FDdEIsVUFBQyxRQUFrQixJQUFLLE9BQUEsUUFBUSxDQUFDLE1BQU0sS0FBSyxXQUFXLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxPQUFPLEVBQTlELENBQThELENBQ3ZGLENBQUMsTUFBTSxDQUFDO0lBQ1gsQ0FBQzs7SUE3SlUsY0FBYztRQUQxQixVQUFVLENBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLENBQUM7O09BQ3RCLGNBQWMsQ0E4SjFCO3lCQTNLRDtDQTJLQyxBQTlKRCxJQThKQztTQTlKWSxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgVXBsb2FkU3RhdGUsXG4gIFVwbG9hZFN0YXR1cyxcbiAgVXBsb2FkeENvbnRyb2xFdmVudCxcbiAgVXBsb2FkeE9wdGlvbnMsXG4gIFVwbG9hZEV2ZW50XG59IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBVcGxvYWRlciwgVXBsb2FkZXJPcHRpb25zIH0gZnJvbSAnLi91cGxvYWRlcic7XG5pbXBvcnQgeyBtYXAsIHN0YXJ0V2l0aCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBVcGxvYWR4U2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgZXZlbnRzU3RyZWFtOiBTdWJqZWN0PFVwbG9hZFN0YXRlPiA9IG5ldyBTdWJqZWN0KCk7XG4gIGdldCBldmVudHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuZXZlbnRzU3RyZWFtLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG4gIHF1ZXVlOiBVcGxvYWRlcltdID0gW107XG4gIHByaXZhdGUgY29uY3VycmVuY3kgPSAyO1xuICBwcml2YXRlIGF1dG9VcGxvYWQgPSB0cnVlO1xuICBwcml2YXRlIG9wdGlvbnM6IFVwbG9hZHhPcHRpb25zO1xuICBzdGF0ZUNoYW5nZSA9IChldnQ6IFVwbG9hZFN0YXRlKSA9PiB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmV2ZW50c1N0cmVhbS5uZXh0KGV2dCk7XG4gICAgfSk7XG4gIH07XG5cbiAgZ2V0IHVwbG9hZGVyT3B0aW9ucygpOiBVcGxvYWRlck9wdGlvbnMge1xuICAgIHJldHVybiB7XG4gICAgICBtZXRob2Q6IHRoaXMub3B0aW9ucy5tZXRob2QgfHwgJ1BPU1QnLFxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBkZXByZWNhdGlvblxuICAgICAgZW5kcG9pbnQ6IHRoaXMub3B0aW9ucy5lbmRwb2ludCB8fCB0aGlzLm9wdGlvbnMudXJsIHx8ICcvdXBsb2FkJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMub3B0aW9ucy5oZWFkZXJzLFxuICAgICAgbWV0YWRhdGE6IHRoaXMub3B0aW9ucy5tZXRhZGF0YSxcbiAgICAgIHRva2VuOiB0aGlzLm9wdGlvbnMudG9rZW4sXG4gICAgICBjaHVua1NpemU6IHRoaXMub3B0aW9ucy5jaHVua1NpemUsXG4gICAgICB3aXRoQ3JlZGVudGlhbHM6IHRoaXMub3B0aW9ucy53aXRoQ3JlZGVudGlhbHMsXG4gICAgICBtYXhSZXRyeUF0dGVtcHRzOiB0aGlzLm9wdGlvbnMubWF4UmV0cnlBdHRlbXB0cyxcbiAgICAgIHN0YXRlQ2hhbmdlOiB0aGlzLnN0YXRlQ2hhbmdlXG4gICAgfTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuZXZlbnRzLnN1YnNjcmliZSgoZXZ0OiBVcGxvYWRFdmVudCkgPT4ge1xuICAgICAgaWYgKGV2dC5zdGF0dXMgIT09ICd1cGxvYWRpbmcnICYmIGV2dC5zdGF0dXMgIT09ICdhZGRlZCcpIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzUXVldWUoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICAvKipcbiAgICogSW5pdGlhbGl6ZXMgc2VydmljZVxuICAgKiBAcGFyYW0gb3B0aW9ucyBnbG9iYWwgb3B0aW9uc1xuICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlIHRoYXQgZW1pdHMgYSBuZXcgdmFsdWUgb24gcHJvZ3Jlc3Mgb3Igc3RhdHVzIGNoYW5nZXNcbiAgICovXG4gIGluaXQob3B0aW9uczogVXBsb2FkeE9wdGlvbnMpOiBPYnNlcnZhYmxlPFVwbG9hZFN0YXRlPiB7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgICB0aGlzLmNvbmN1cnJlbmN5ID0gb3B0aW9ucy5jb25jdXJyZW5jeSB8fCB0aGlzLmNvbmN1cnJlbmN5O1xuICAgIHRoaXMuYXV0b1VwbG9hZCA9ICEob3B0aW9ucy5hdXRvVXBsb2FkID09PSBmYWxzZSk7XG4gICAgcmV0dXJuIHRoaXMuZXZlbnRzO1xuICB9XG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyBzZXJ2aWNlXG4gICAqIEBwYXJhbSBvcHRpb25zIGdsb2JhbCBvcHRpb25zXG4gICAqIEByZXR1cm5zIE9ic2VydmFibGUgdGhhdCBlbWl0cyB0aGUgY3VycmVudCBxdWV1ZVxuICAgKi9cbiAgY29ubmVjdChvcHRpb25zPzogVXBsb2FkeE9wdGlvbnMpOiBPYnNlcnZhYmxlPFVwbG9hZGVyW10+IHtcbiAgICByZXR1cm4gdGhpcy5pbml0KG9wdGlvbnMgfHwgdGhpcy5vcHRpb25zKS5waXBlKFxuICAgICAgc3RhcnRXaXRoKDApLFxuICAgICAgbWFwKCgpID0+IHRoaXMucXVldWUpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUZXJtaW5hdGUgYWxsIHVwbG9hZHMgYW5kIGNsZWFycyB0aGUgcXVldWVcbiAgICovXG4gIGRpc2Nvbm5lY3QoKSB7XG4gICAgdGhpcy5xdWV1ZS5mb3JFYWNoKGYgPT4gKGYuc3RhdHVzID0gJ3BhdXNlZCcpKTtcbiAgICB0aGlzLnF1ZXVlID0gW107XG4gIH1cbiAgLyoqXG4gICAqIENyZWF0ZSBVcGxvYWRlciBhbmQgYWRkIHRvIHRoZSBxdWV1ZVxuICAgKi9cbiAgaGFuZGxlRmlsZUxpc3QoZmlsZUxpc3Q6IEZpbGVMaXN0KSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaWxlTGlzdC5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgdXBsb2FkZXI6IFVwbG9hZGVyID0gbmV3IFVwbG9hZGVyKGZpbGVMaXN0Lml0ZW0oaSksIHRoaXMudXBsb2FkZXJPcHRpb25zKTtcbiAgICAgIHRoaXMucXVldWUucHVzaCh1cGxvYWRlcik7XG4gICAgICB1cGxvYWRlci5zdGF0dXMgPSAnYWRkZWQnO1xuICAgIH1cbiAgICB0aGlzLmF1dG9VcGxvYWRGaWxlcygpO1xuICB9XG4gIC8qKlxuICAgKiBDcmVhdGUgVXBsb2FkZXIgZm9yIHRoZSBmaWxlIGFuZCBhZGQgdG8gdGhlIHF1ZXVlXG4gICAqL1xuICBoYW5kbGVGaWxlKGZpbGU6IEZpbGUpOiB2b2lkIHtcbiAgICBjb25zdCB1cGxvYWRlcjogVXBsb2FkZXIgPSBuZXcgVXBsb2FkZXIoZmlsZSwgdGhpcy51cGxvYWRlck9wdGlvbnMpO1xuICAgIHRoaXMucXVldWUucHVzaCh1cGxvYWRlcik7XG4gICAgdXBsb2FkZXIuc3RhdHVzID0gJ2FkZGVkJztcbiAgICB0aGlzLmF1dG9VcGxvYWRGaWxlcygpO1xuICB9XG4gIC8qKlxuICAgKiBBdXRvIHVwbG9hZCB0aGUgZmlsZXMgaWYgdGhlIGZsYWcgaXMgdHJ1ZVxuICAgKiBAaW50ZXJuYWxcbiAgICovXG4gIHByaXZhdGUgYXV0b1VwbG9hZEZpbGVzKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmF1dG9VcGxvYWQpIHtcbiAgICAgIHRoaXMucXVldWUuZmlsdGVyKGYgPT4gZi5zdGF0dXMgPT09ICdhZGRlZCcpLmZvckVhY2goZiA9PiAoZi5zdGF0dXMgPSAncXVldWUnKSk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiBDb250cm9sIHVwbG9hZHMgc3RhdHVzXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMudXBsb2FkU2VydmljZS5jb250cm9sKHsgYWN0aW9uOiAncGF1c2VBbGwnIH0pO1xuICAgKlxuICAgKi9cbiAgY29udHJvbChldmVudDogVXBsb2FkeENvbnRyb2xFdmVudCk6IHZvaWQge1xuICAgIHN3aXRjaCAoZXZlbnQuYWN0aW9uKSB7XG4gICAgICBjYXNlICdjYW5jZWxBbGwnOlxuICAgICAgICB0aGlzLnF1ZXVlLmZvckVhY2goZiA9PiAoZi5zdGF0dXMgPSAnY2FuY2VsbGVkJykpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3BhdXNlQWxsJzpcbiAgICAgICAgdGhpcy5xdWV1ZS5mb3JFYWNoKGYgPT4gKGYuc3RhdHVzID0gJ3BhdXNlZCcpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdyZWZyZXNoVG9rZW4nOlxuICAgICAgICB0aGlzLnF1ZXVlLmZvckVhY2goZiA9PiBmLnJlZnJlc2hUb2tlbihldmVudC50b2tlbikpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3VwbG9hZEFsbCc6XG4gICAgICAgIHRoaXMucXVldWUuZmlsdGVyKGYgPT4gZi5zdGF0dXMgIT09ICd1cGxvYWRpbmcnKS5mb3JFYWNoKGYgPT4gKGYuc3RhdHVzID0gJ3F1ZXVlJykpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3VwbG9hZCc6XG4gICAgICAgIGNvbnN0IHVwbG9hZElkID0gZXZlbnQudXBsb2FkSWQgfHwgZXZlbnQuaXRlbU9wdGlvbnMudXBsb2FkSWQ7XG4gICAgICAgIGNvbnN0IHVwbG9hZCA9IHRoaXMucXVldWUuZmluZChmID0+IGYudXBsb2FkSWQgPT09IHVwbG9hZElkKTtcbiAgICAgICAgdXBsb2FkLmNvbmZpZ3VyZShldmVudC5pdGVtT3B0aW9ucyk7XG4gICAgICAgIHVwbG9hZC5zdGF0dXMgPSAncXVldWUnIGFzIFVwbG9hZFN0YXR1cztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdjYW5jZWwnOlxuICAgICAgICB0aGlzLnF1ZXVlLmZpbmQoZiA9PiBmLnVwbG9hZElkID09PSBldmVudC51cGxvYWRJZCkuc3RhdHVzID0gJ2NhbmNlbGxlZCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAncGF1c2UnOlxuICAgICAgICB0aGlzLnF1ZXVlLmZpbmQoZiA9PiBmLnVwbG9hZElkID09PSBldmVudC51cGxvYWRJZCkuc3RhdHVzID0gJ3BhdXNlZCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFF1ZXVlIG1hbmFnZW1lbnRcbiAgICogQGludGVybmFsXG4gICAqL1xuICBwcml2YXRlIHByb2Nlc3NRdWV1ZSgpIHtcbiAgICAvLyBSZW1vdmUgQ2FuY2VsbGVkIEl0ZW1zIGZyb20gbG9jYWwgcXVldWVcbiAgICB0aGlzLnF1ZXVlID0gdGhpcy5xdWV1ZS5maWx0ZXIoZiA9PiBmLnN0YXR1cyAhPT0gJ2NhbmNlbGxlZCcpO1xuXG4gICAgY29uc3QgcnVubmluZyA9IHRoaXMucnVubmluZ1Byb2Nlc3MoKTtcblxuICAgIHRoaXMucXVldWVcbiAgICAgIC5maWx0ZXIoKHVwbG9hZGVyOiBVcGxvYWRlcikgPT4gdXBsb2FkZXIuc3RhdHVzID09PSAncXVldWUnKVxuICAgICAgLnNsaWNlKDAsIE1hdGgubWF4KHRoaXMuY29uY3VycmVuY3kgLSBydW5uaW5nLCAwKSlcbiAgICAgIC5mb3JFYWNoKCh1cGxvYWRlcjogVXBsb2FkZXIpID0+IHtcbiAgICAgICAgdXBsb2FkZXIudXBsb2FkKCk7XG4gICAgICB9KTtcbiAgfVxuICAvKipcbiAgICogQHJldHVybnMgIG51bWJlciBvZiBhY3RpdmUgdXBsb2Fkc1xuICAgKi9cbiAgcnVubmluZ1Byb2Nlc3MoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5xdWV1ZS5maWx0ZXIoXG4gICAgICAodXBsb2FkZXI6IFVwbG9hZGVyKSA9PiB1cGxvYWRlci5zdGF0dXMgPT09ICd1cGxvYWRpbmcnIHx8IHVwbG9hZGVyLnN0YXR1cyA9PT0gJ3JldHJ5J1xuICAgICkubGVuZ3RoO1xuICB9XG59XG4iXX0=