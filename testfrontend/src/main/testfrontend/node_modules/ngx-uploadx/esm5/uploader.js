/**
 * Implements XHR/CORS Resumable Upload
 * @see
 * https://developers.google.com/drive/v3/web/resumable-upload
 */
import * as tslib_1 from "tslib";
import { resolveUrl } from './resolve_url';
import { BackoffRetry } from './backoff_retry';
var noop = function () { };
var Éµ0 = noop;
var Uploader = /** @class */ (function () {
    /**
     * Creates an instance of Uploader.
     */
    function Uploader(file, options) {
        this.file = file;
        this.options = options;
        this.retry = new BackoffRetry();
        this.chunkSize = 1048576;
        this.maxRetryAttempts = 3;
        this.uploadId = Math.random()
            .toString(36)
            .substring(2, 15);
        this.name = file.name;
        this.size = file.size;
        this.mimeType = file.type || 'application/octet-stream';
        this.stateChange = options.stateChange || noop;
        this.configure(options);
    }
    Object.defineProperty(Uploader.prototype, "status", {
        get: function () {
            return this._status;
        },
        set: function (s) {
            // Return if State is cancelled or complete (but allow cancel of an complete upload to remove from list and from server)
            if (this._status === 'cancelled' || (this._status === 'complete' && s !== 'cancelled')) {
                return;
            }
            if (s !== this._status) {
                if (this._xhr_ && (s === 'cancelled' || s === 'paused')) {
                    this._xhr_.abort();
                }
                if (s === 'cancelled' && this.URI) {
                    this.request('delete');
                }
                this._status = s;
                this.notifyState();
            }
        },
        enumerable: true,
        configurable: true
    });
    /**
     * configure or reconfigure uploader
     */
    Uploader.prototype.configure = function (item) {
        if (item === void 0) { item = {}; }
        var metadata = item.metadata, headers = item.headers, token = item.token, endpoint = item.endpoint;
        this.metadata = tslib_1.__assign({ name: this.name, mimeType: this.mimeType, size: this.file.size, lastModified: this.file.lastModified }, unfunc(metadata || this.metadata, this.file));
        this.endpoint = endpoint || this.options.endpoint;
        this.chunkSize = this.options.chunkSize || this.chunkSize;
        this.maxRetryAttempts = this.options.maxRetryAttempts || this.maxRetryAttempts;
        this.refreshToken(token);
        this.headers = tslib_1.__assign({}, this.headers, unfunc(headers, this.file));
    };
    /**
     * Emit current state
     */
    Uploader.prototype.notifyState = function () {
        var state = {
            file: this.file,
            name: this.name,
            progress: this.progress,
            percentage: this.progress,
            remaining: this.remaining,
            response: this.response,
            responseStatus: this.responseStatus,
            size: this.size,
            speed: this.speed,
            status: this._status,
            uploadId: this.uploadId,
            URI: this.URI
        };
        this.stateChange(state);
    };
    Uploader.prototype.processResponse = function (xhr) {
        this.responseStatus = xhr.status;
        this.response = parseJson(xhr);
        this.statusType = xhr.status - (xhr.status % 100);
    };
    Uploader.prototype.refreshToken = function (token) {
        this.token = token || this.token;
        this._token = unfunc(this.token);
    };
    Uploader.prototype.maxAttemptsReached = function () {
        if (this.retry.retryAttempts === this.maxRetryAttempts && this.statusType === 400) {
            this.retry.reset();
            console.error("Error: Maximum number of retry attempts reached:\n          file: " + this.name + ",\n          statusCode: " + this.responseStatus);
            return true;
        }
    };
    Uploader.prototype.create = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (!_this.URI || _this.responseStatus === 404) {
                // get file URI
                var xhr_1 = new XMLHttpRequest();
                xhr_1.open(_this.options.method.toUpperCase(), _this.endpoint, true);
                _this.setupXHR(xhr_1);
                xhr_1.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
                xhr_1.setRequestHeader('X-Upload-Content-Length', _this.size.toString());
                xhr_1.setRequestHeader('X-Upload-Content-Type', _this.mimeType);
                xhr_1.onload = function () {
                    _this.processResponse(xhr_1);
                    var location = _this.statusType === 200 && getKeyFromResponse(xhr_1, 'location');
                    if (!location) {
                        // limit attempts
                        _this.statusType = 400;
                        reject();
                    }
                    else {
                        _this.URI = resolveUrl(location, _this.endpoint);
                        _this.retry.reset();
                        resolve();
                    }
                };
                xhr_1.onerror = function () { return reject(); };
                xhr_1.send(JSON.stringify(_this.metadata));
            }
            else {
                resolve();
            }
        });
    };
    /**
     * Initiate upload
     */
    Uploader.prototype.upload = function (item) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var e_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (item)
                            this.configure(item);
                        if (this._status === 'cancelled' || this._status === 'complete' || this._status === 'paused') {
                            return [2 /*return*/];
                        }
                        this.status = 'uploading';
                        this.refreshToken();
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 7]);
                        return [4 /*yield*/, this.create()];
                    case 2:
                        _a.sent();
                        this.startTime = new Date().getTime();
                        this.sendChunk(this.progress ? undefined : 0);
                        return [3 /*break*/, 7];
                    case 3:
                        e_1 = _a.sent();
                        if (!this.maxAttemptsReached()) return [3 /*break*/, 4];
                        this.status = 'error';
                        return [3 /*break*/, 6];
                    case 4:
                        this.status = 'retry';
                        return [4 /*yield*/, this.retry.wait(this.responseStatus)];
                    case 5:
                        _a.sent();
                        this.status = 'queue';
                        _a.label = 6;
                    case 6: return [3 /*break*/, 7];
                    case 7: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Chunk upload +/ get offset
     */
    Uploader.prototype.sendChunk = function (offset) {
        if (this.status === 'uploading') {
            var body = null;
            var xhr = new XMLHttpRequest();
            xhr.open('PUT', this.URI, true);
            this.setupXHR(xhr);
            this.setupEvents(xhr);
            if (offset >= 0 && offset < this.size) {
                var end = this.chunkSize ? Math.min(offset + this.chunkSize, this.size) : this.size;
                body = this.file.slice(offset, end);
                xhr.upload.onprogress = this.setupProgressEvent(offset, end);
                xhr.setRequestHeader('Content-Range', "bytes " + offset + "-" + (end - 1) + "/" + this.size);
                xhr.setRequestHeader('Content-Type', 'application/octet-stream');
            }
            else {
                xhr.setRequestHeader('Content-Range', "bytes */" + this.size);
            }
            xhr.send(body);
        }
    };
    Uploader.prototype.setupEvents = function (xhr) {
        var _this = this;
        var onError = function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (this.maxAttemptsReached()) {
                            this.status = 'error';
                            return [2 /*return*/];
                        }
                        this.status = 'retry';
                        return [4 /*yield*/, this.retry.wait(xhr.status)];
                    case 1:
                        _a.sent();
                        if (xhr.status === 404) {
                            this.status = 'queue';
                            return [2 /*return*/];
                        }
                        if (xhr.status === 413) {
                            this.chunkSize /= 2;
                        }
                        this.refreshToken();
                        this.status = 'uploading';
                        // request offset
                        this.sendChunk();
                        return [2 /*return*/];
                }
            });
        }); };
        var onSuccess = function () {
            _this.processResponse(xhr);
            var offset = _this.statusType === 300 && _this.getNextChunkOffset(xhr);
            if (typeof offset === 'number') {
                //  next chunk
                _this.retry.reset();
                _this.sendChunk(offset);
            }
            else if (_this.statusType === 200) {
                _this.progress = 100;
                _this.status = 'complete';
            }
            else {
                onError();
            }
        };
        xhr.onerror = onError;
        xhr.onload = onSuccess;
    };
    Uploader.prototype.setupProgressEvent = function (offset, end) {
        var _this = this;
        return function (pEvent) {
            var uploaded = pEvent.lengthComputable
                ? offset + (end - offset) * (pEvent.loaded / pEvent.total)
                : offset;
            _this.progress = +((uploaded / _this.size) * 100).toFixed(2);
            var now = new Date().getTime();
            _this.speed = Math.round((uploaded / (now - _this.startTime)) * 1000);
            _this.remaining = Math.ceil((_this.size - uploaded) / _this.speed);
            _this.notifyState();
        };
    };
    Uploader.prototype.getNextChunkOffset = function (xhr) {
        var str = getKeyFromResponse(xhr, 'Range');
        var _a = tslib_1.__read(str && str.match(/(-1|\d+)$/g), 1), match = _a[0];
        return match && +match + 1;
    };
    Uploader.prototype.setupXHR = function (xhr) {
        var _this = this;
        //reset response
        this.responseStatus = null;
        this.response = null;
        this.statusType = null;
        this._xhr_ = xhr;
        xhr.responseType = 'json';
        xhr.withCredentials = this.options.withCredentials;
        Object.keys(this.headers).forEach(function (key) { return xhr.setRequestHeader(key, _this.headers[key]); });
        // tslint:disable-next-line: no-unused-expression
        this._token && xhr.setRequestHeader('Authorization', "Bearer " + this._token);
    };
    Uploader.prototype.request = function (method, payload) {
        var _this = this;
        if (payload === void 0) { payload = null; }
        return new Promise(function (resolve, reject) {
            var xhr = new XMLHttpRequest();
            xhr.open(method.toUpperCase(), _this.URI, true);
            _this.setupXHR(xhr);
            xhr.onload = function () {
                _this.processResponse(xhr);
                resolve();
            };
            xhr.onerror = function () { return reject(); };
            var body = payload ? JSON.stringify(payload) : null;
            xhr.send(body);
        });
    };
    return Uploader;
}());
export { Uploader };
function getKeyFromResponse(xhr, key) {
    var fromHeader = xhr.getResponseHeader(key);
    if (fromHeader) {
        return fromHeader;
    }
    var response = parseJson(xhr) || {};
    var resKey = Object.keys(response).find(function (k) { return k.toLowerCase() === key.toLowerCase(); });
    return response[resKey];
}
function parseJson(xhr) {
    return typeof xhr.response === 'object' ? xhr.response : JSON.parse(xhr.responseText || null);
}
function unfunc(value, file) {
    return value instanceof Function ? value(file) : value;
}
export { Éµ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtdXBsb2FkeC8iLCJzb3VyY2VzIjpbInVwbG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7O0FBRUgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFZL0MsSUFBTSxJQUFJLEdBQUcsY0FBTyxDQUFDLENBQUM7O0FBRXRCO0lBOENFOztPQUVHO0lBQ0gsa0JBQTZCLElBQVUsRUFBUyxPQUF3QjtRQUEzQyxTQUFJLEdBQUosSUFBSSxDQUFNO1FBQVMsWUFBTyxHQUFQLE9BQU8sQ0FBaUI7UUE1Q2hFLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBZ0IzQixjQUFTLEdBQUcsT0FBUyxDQUFDO1FBQ3RCLHFCQUFnQixHQUFHLENBQUMsQ0FBQztRQTRCM0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFO2FBQzFCLFFBQVEsQ0FBQyxFQUFFLENBQUM7YUFDWixTQUFTLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLDBCQUEwQixDQUFDO1FBQ3hELElBQUksQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUM7UUFDL0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBakNELHNCQUFJLDRCQUFNO2FBaUJWO1lBQ0UsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ3RCLENBQUM7YUFuQkQsVUFBVyxDQUFlO1lBQ3hCLHdIQUF3SDtZQUN4SCxJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssV0FBVyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sS0FBSyxVQUFVLElBQUksQ0FBQyxLQUFLLFdBQVcsQ0FBQyxFQUFFO2dCQUN0RixPQUFPO2FBQ1I7WUFDRCxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsT0FBTyxFQUFFO2dCQUN0QixJQUFJLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLEtBQUssV0FBVyxJQUFJLENBQUMsS0FBSyxRQUFRLENBQUMsRUFBRTtvQkFDdkQsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztpQkFDcEI7Z0JBQ0QsSUFBSSxDQUFDLEtBQUssV0FBVyxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUU7b0JBQ2pDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7aUJBQ3hCO2dCQUNELElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO2dCQUNqQixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7YUFDcEI7UUFDSCxDQUFDOzs7T0FBQTtJQW9CRDs7T0FFRztJQUNILDRCQUFTLEdBQVQsVUFBVSxJQUF1QjtRQUF2QixxQkFBQSxFQUFBLE9BQU8sRUFBZ0I7UUFDdkIsSUFBQSx3QkFBUSxFQUFFLHNCQUFPLEVBQUUsa0JBQUssRUFBRSx3QkFBUSxDQUFVO1FBQ3BELElBQUksQ0FBQyxRQUFRLHNCQUNYLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUNmLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUN2QixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQ3BCLFlBQVksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksSUFDakMsTUFBTSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FDaEQsQ0FBQztRQUNGLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDO1FBQ2xELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUMxRCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFDL0UsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6QixJQUFJLENBQUMsT0FBTyx3QkFBUSxJQUFJLENBQUMsT0FBTyxFQUFLLE1BQU0sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFFLENBQUM7SUFDcEUsQ0FBQztJQUVEOztPQUVHO0lBQ0ssOEJBQVcsR0FBbkI7UUFDRSxJQUFNLEtBQUssR0FBZ0I7WUFDekIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO1lBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO1lBQ2YsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO1lBQ3ZCLFVBQVUsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUN6QixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO1lBQ3ZCLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYztZQUNuQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFDakIsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPO1lBQ3BCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUN2QixHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUc7U0FDZCxDQUFDO1FBQ0YsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRU8sa0NBQWUsR0FBdkIsVUFBd0IsR0FBbUI7UUFDekMsSUFBSSxDQUFDLGNBQWMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9CLElBQUksQ0FBQyxVQUFVLEdBQUcsR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVELCtCQUFZLEdBQVosVUFBYSxLQUFXO1FBQ3RCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDakMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFTyxxQ0FBa0IsR0FBMUI7UUFDRSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxLQUFLLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxJQUFJLENBQUMsVUFBVSxLQUFLLEdBQUcsRUFBRTtZQUNqRixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ25CLE9BQU8sQ0FBQyxLQUFLLENBQ1gsdUVBQ1UsSUFBSSxDQUFDLElBQUksaUNBQ0gsSUFBSSxDQUFDLGNBQWdCLENBQ3RDLENBQUM7WUFDRixPQUFPLElBQUksQ0FBQztTQUNiO0lBQ0gsQ0FBQztJQUVPLHlCQUFNLEdBQWQ7UUFBQSxpQkE2QkM7UUE1QkMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQ2pDLElBQUksQ0FBQyxLQUFJLENBQUMsR0FBRyxJQUFJLEtBQUksQ0FBQyxjQUFjLEtBQUssR0FBRyxFQUFFO2dCQUM1QyxlQUFlO2dCQUNmLElBQU0sS0FBRyxHQUFtQixJQUFJLGNBQWMsRUFBRSxDQUFDO2dCQUNqRCxLQUFHLENBQUMsSUFBSSxDQUFDLEtBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxFQUFFLEtBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ2pFLEtBQUksQ0FBQyxRQUFRLENBQUMsS0FBRyxDQUFDLENBQUM7Z0JBQ25CLEtBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLEVBQUUsaUNBQWlDLENBQUMsQ0FBQztnQkFDeEUsS0FBRyxDQUFDLGdCQUFnQixDQUFDLHlCQUF5QixFQUFFLEtBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztnQkFDdEUsS0FBRyxDQUFDLGdCQUFnQixDQUFDLHVCQUF1QixFQUFFLEtBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDN0QsS0FBRyxDQUFDLE1BQU0sR0FBRztvQkFDWCxLQUFJLENBQUMsZUFBZSxDQUFDLEtBQUcsQ0FBQyxDQUFDO29CQUMxQixJQUFNLFFBQVEsR0FBRyxLQUFJLENBQUMsVUFBVSxLQUFLLEdBQUcsSUFBSSxrQkFBa0IsQ0FBQyxLQUFHLEVBQUUsVUFBVSxDQUFDLENBQUM7b0JBQ2hGLElBQUksQ0FBQyxRQUFRLEVBQUU7d0JBQ2IsaUJBQWlCO3dCQUNqQixLQUFJLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQzt3QkFDdEIsTUFBTSxFQUFFLENBQUM7cUJBQ1Y7eUJBQU07d0JBQ0wsS0FBSSxDQUFDLEdBQUcsR0FBRyxVQUFVLENBQUMsUUFBUSxFQUFFLEtBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzt3QkFDL0MsS0FBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQzt3QkFDbkIsT0FBTyxFQUFFLENBQUM7cUJBQ1g7Z0JBQ0gsQ0FBQyxDQUFDO2dCQUNGLEtBQUcsQ0FBQyxPQUFPLEdBQUcsY0FBTSxPQUFBLE1BQU0sRUFBRSxFQUFSLENBQVEsQ0FBQztnQkFDN0IsS0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2FBQ3pDO2lCQUFNO2dCQUNMLE9BQU8sRUFBRSxDQUFDO2FBQ1g7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNHLHlCQUFNLEdBQVosVUFBYSxJQUE2Qjs7Ozs7O3dCQUN4QyxJQUFJLElBQUk7NEJBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDL0IsSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLFdBQVcsSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLFVBQVUsSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLFFBQVEsRUFBRTs0QkFDNUYsc0JBQU87eUJBQ1I7d0JBQ0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxXQUFXLENBQUM7d0JBQzFCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQzs7Ozt3QkFFbEIscUJBQU0sSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFBOzt3QkFBbkIsU0FBbUIsQ0FBQzt3QkFDcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO3dCQUN0QyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Ozs7NkJBRTFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxFQUF6Qix3QkFBeUI7d0JBQzNCLElBQUksQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDOzs7d0JBRXRCLElBQUksQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDO3dCQUN0QixxQkFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQUE7O3dCQUExQyxTQUEwQyxDQUFDO3dCQUMzQyxJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQzs7Ozs7OztLQUczQjtJQUVEOztPQUVHO0lBQ0ssNEJBQVMsR0FBakIsVUFBa0IsTUFBZTtRQUMvQixJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssV0FBVyxFQUFFO1lBQy9CLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztZQUNoQixJQUFNLEdBQUcsR0FBbUIsSUFBSSxjQUFjLEVBQUUsQ0FBQztZQUNqRCxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbkIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0QixJQUFJLE1BQU0sSUFBSSxDQUFDLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUU7Z0JBQ3JDLElBQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO2dCQUN0RixJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUNwQyxHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUM3RCxHQUFHLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxFQUFFLFdBQVMsTUFBTSxVQUFJLEdBQUcsR0FBRyxDQUFDLFVBQUksSUFBSSxDQUFDLElBQU0sQ0FBQyxDQUFDO2dCQUNqRixHQUFHLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxFQUFFLDBCQUEwQixDQUFDLENBQUM7YUFDbEU7aUJBQU07Z0JBQ0wsR0FBRyxDQUFDLGdCQUFnQixDQUFDLGVBQWUsRUFBRSxhQUFXLElBQUksQ0FBQyxJQUFNLENBQUMsQ0FBQzthQUMvRDtZQUNELEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDaEI7SUFDSCxDQUFDO0lBRU8sOEJBQVcsR0FBbkIsVUFBb0IsR0FBbUI7UUFBdkMsaUJBb0NDO1FBbkNDLElBQU0sT0FBTyxHQUFHOzs7O3dCQUNkLElBQUksSUFBSSxDQUFDLGtCQUFrQixFQUFFLEVBQUU7NEJBQzdCLElBQUksQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDOzRCQUN0QixzQkFBTzt5QkFDUjt3QkFDRCxJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQzt3QkFDdEIscUJBQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFBOzt3QkFBakMsU0FBaUMsQ0FBQzt3QkFDbEMsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLEdBQUcsRUFBRTs0QkFDdEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUM7NEJBQ3RCLHNCQUFPO3lCQUNSO3dCQUNELElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7NEJBQ3RCLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxDQUFDO3lCQUNyQjt3QkFDRCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7d0JBQ3BCLElBQUksQ0FBQyxNQUFNLEdBQUcsV0FBVyxDQUFDO3dCQUMxQixpQkFBaUI7d0JBQ2pCLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQzs7OzthQUNsQixDQUFDO1FBQ0YsSUFBTSxTQUFTLEdBQUc7WUFDaEIsS0FBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMxQixJQUFNLE1BQU0sR0FBRyxLQUFJLENBQUMsVUFBVSxLQUFLLEdBQUcsSUFBSSxLQUFJLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdkUsSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7Z0JBQzlCLGNBQWM7Z0JBQ2QsS0FBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDbkIsS0FBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUN4QjtpQkFBTSxJQUFJLEtBQUksQ0FBQyxVQUFVLEtBQUssR0FBRyxFQUFFO2dCQUNsQyxLQUFJLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQztnQkFDcEIsS0FBSSxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUM7YUFDMUI7aUJBQU07Z0JBQ0wsT0FBTyxFQUFFLENBQUM7YUFDWDtRQUNILENBQUMsQ0FBQztRQUNGLEdBQUcsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3RCLEdBQUcsQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDO0lBQ3pCLENBQUM7SUFFTyxxQ0FBa0IsR0FBMUIsVUFBMkIsTUFBYyxFQUFFLEdBQVc7UUFBdEQsaUJBV0M7UUFWQyxPQUFPLFVBQUMsTUFBcUI7WUFDM0IsSUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLGdCQUFnQjtnQkFDdEMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQztnQkFDMUQsQ0FBQyxDQUFDLE1BQU0sQ0FBQztZQUNYLEtBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxHQUFHLEtBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0QsSUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNqQyxLQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxHQUFHLEdBQUcsS0FBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7WUFDcEUsS0FBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsR0FBRyxLQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEUsS0FBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3JCLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFTyxxQ0FBa0IsR0FBMUIsVUFBMkIsR0FBbUI7UUFDNUMsSUFBTSxHQUFHLEdBQUcsa0JBQWtCLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZDLElBQUEsc0RBQXdDLEVBQXZDLGFBQXVDLENBQUM7UUFDL0MsT0FBTyxLQUFLLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFTywyQkFBUSxHQUFoQixVQUFpQixHQUFtQjtRQUFwQyxpQkFhQztRQVpDLGdCQUFnQjtRQUNoQixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztRQUMzQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUNyQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUV2QixJQUFJLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQztRQUVqQixHQUFHLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQztRQUMxQixHQUFHLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDO1FBQ25ELE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsS0FBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUE1QyxDQUE0QyxDQUFDLENBQUM7UUFDdkYsaURBQWlEO1FBQ2pELElBQUksQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFDLGdCQUFnQixDQUFDLGVBQWUsRUFBRSxZQUFVLElBQUksQ0FBQyxNQUFRLENBQUMsQ0FBQztJQUNoRixDQUFDO0lBRUQsMEJBQU8sR0FBUCxVQUFRLE1BQWMsRUFBRSxPQUFjO1FBQXRDLGlCQWFDO1FBYnVCLHdCQUFBLEVBQUEsY0FBYztRQUNwQyxPQUFPLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFDakMsSUFBTSxHQUFHLEdBQW1CLElBQUksY0FBYyxFQUFFLENBQUM7WUFDakQsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLEVBQUUsS0FBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUMvQyxLQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ25CLEdBQUcsQ0FBQyxNQUFNLEdBQUc7Z0JBQ1gsS0FBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDMUIsT0FBTyxFQUFFLENBQUM7WUFDWixDQUFDLENBQUM7WUFDRixHQUFHLENBQUMsT0FBTyxHQUFHLGNBQU0sT0FBQSxNQUFNLEVBQUUsRUFBUixDQUFRLENBQUM7WUFDN0IsSUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDdEQsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqQixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDSCxlQUFDO0FBQUQsQ0FBQyxBQWhTRCxJQWdTQzs7QUFFRCxTQUFTLGtCQUFrQixDQUFDLEdBQW1CLEVBQUUsR0FBVztJQUMxRCxJQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDOUMsSUFBSSxVQUFVLEVBQUU7UUFDZCxPQUFPLFVBQVUsQ0FBQztLQUNuQjtJQUNELElBQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDdEMsSUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsV0FBVyxFQUFFLEtBQUssR0FBRyxDQUFDLFdBQVcsRUFBRSxFQUFyQyxDQUFxQyxDQUFDLENBQUM7SUFDdEYsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDMUIsQ0FBQztBQUVELFNBQVMsU0FBUyxDQUFDLEdBQW1CO0lBQ3BDLE9BQU8sT0FBTyxHQUFHLENBQUMsUUFBUSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxDQUFDO0FBQ2hHLENBQUM7QUFFRCxTQUFTLE1BQU0sQ0FBSSxLQUE4QixFQUFFLElBQVc7SUFDNUQsT0FBTyxLQUFLLFlBQVksUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUN6RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBJbXBsZW1lbnRzIFhIUi9DT1JTIFJlc3VtYWJsZSBVcGxvYWRcbiAqIEBzZWVcbiAqIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2RyaXZlL3YzL3dlYi9yZXN1bWFibGUtdXBsb2FkXG4gKi9cblxuaW1wb3J0IHsgcmVzb2x2ZVVybCB9IGZyb20gJy4vcmVzb2x2ZV91cmwnO1xuaW1wb3J0IHsgQmFja29mZlJldHJ5IH0gZnJvbSAnLi9iYWNrb2ZmX3JldHJ5JztcbmltcG9ydCB7IFVwbG9hZFN0YXR1cywgVXBsb2FkSXRlbSwgVXBsb2FkU3RhdGUgfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuXG4vKipcbiAqXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgVXBsb2FkZXJPcHRpb25zIGV4dGVuZHMgVXBsb2FkSXRlbSB7XG4gIG1heFJldHJ5QXR0ZW1wdHM6IG51bWJlcjtcbiAgY2h1bmtTaXplPzogbnVtYmVyO1xuICB3aXRoQ3JlZGVudGlhbHM/OiBib29sZWFuO1xuICByZWFkb25seSBzdGF0ZUNoYW5nZT86IGFueTtcbn1cbmNvbnN0IG5vb3AgPSAoKSA9PiB7fTtcblxuZXhwb3J0IGNsYXNzIFVwbG9hZGVyIHtcbiAgaGVhZGVyczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSB8IG51bGw7XG4gIG1ldGFkYXRhOiB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xuICBlbmRwb2ludDogc3RyaW5nO1xuICBwcml2YXRlIF9zdGF0dXM6IFVwbG9hZFN0YXR1cztcbiAgcHJpdmF0ZSByZXRyeSA9IG5ldyBCYWNrb2ZmUmV0cnkoKTtcbiAgcHJpdmF0ZSBzdGFydFRpbWU6IG51bWJlcjtcbiAgcHJvZ3Jlc3M6IG51bWJlcjtcbiAgcmVhZG9ubHkgbWltZVR5cGU6IHN0cmluZztcbiAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICByZWFkb25seSBzaXplOiBudW1iZXI7XG4gIHJlYWRvbmx5IHVwbG9hZElkOiBzdHJpbmc7XG4gIHJlbWFpbmluZzogbnVtYmVyO1xuICByZXNwb25zZTogYW55O1xuICByZXNwb25zZVN0YXR1czogbnVtYmVyO1xuICBzcGVlZDogbnVtYmVyO1xuICBVUkk6IHN0cmluZztcbiAgdG9rZW46IHN0cmluZyB8ICgoKSA9PiBzdHJpbmcpO1xuICBwcml2YXRlIHN0YXR1c1R5cGU6IG51bWJlcjtcbiAgcHJpdmF0ZSBfdG9rZW46IHN0cmluZztcbiAgcHJpdmF0ZSBfeGhyXzogWE1MSHR0cFJlcXVlc3Q7XG4gIHByaXZhdGUgY2h1bmtTaXplID0gMV8wNDhfNTc2O1xuICBwcml2YXRlIG1heFJldHJ5QXR0ZW1wdHMgPSAzO1xuICBwcml2YXRlIHN0YXRlQ2hhbmdlOiAoZXZ0OiBVcGxvYWRTdGF0ZSkgPT4gdm9pZDtcblxuICBzZXQgc3RhdHVzKHM6IFVwbG9hZFN0YXR1cykge1xuICAgIC8vIFJldHVybiBpZiBTdGF0ZSBpcyBjYW5jZWxsZWQgb3IgY29tcGxldGUgKGJ1dCBhbGxvdyBjYW5jZWwgb2YgYW4gY29tcGxldGUgdXBsb2FkIHRvIHJlbW92ZSBmcm9tIGxpc3QgYW5kIGZyb20gc2VydmVyKVxuICAgIGlmICh0aGlzLl9zdGF0dXMgPT09ICdjYW5jZWxsZWQnIHx8ICh0aGlzLl9zdGF0dXMgPT09ICdjb21wbGV0ZScgJiYgcyAhPT0gJ2NhbmNlbGxlZCcpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChzICE9PSB0aGlzLl9zdGF0dXMpIHtcbiAgICAgIGlmICh0aGlzLl94aHJfICYmIChzID09PSAnY2FuY2VsbGVkJyB8fCBzID09PSAncGF1c2VkJykpIHtcbiAgICAgICAgdGhpcy5feGhyXy5hYm9ydCgpO1xuICAgICAgfVxuICAgICAgaWYgKHMgPT09ICdjYW5jZWxsZWQnICYmIHRoaXMuVVJJKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdCgnZGVsZXRlJyk7XG4gICAgICB9XG4gICAgICB0aGlzLl9zdGF0dXMgPSBzO1xuICAgICAgdGhpcy5ub3RpZnlTdGF0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIGdldCBzdGF0dXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3N0YXR1cztcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFuIGluc3RhbmNlIG9mIFVwbG9hZGVyLlxuICAgKi9cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBmaWxlOiBGaWxlLCBwdWJsaWMgb3B0aW9uczogVXBsb2FkZXJPcHRpb25zKSB7XG4gICAgdGhpcy51cGxvYWRJZCA9IE1hdGgucmFuZG9tKClcbiAgICAgIC50b1N0cmluZygzNilcbiAgICAgIC5zdWJzdHJpbmcoMiwgMTUpO1xuICAgIHRoaXMubmFtZSA9IGZpbGUubmFtZTtcbiAgICB0aGlzLnNpemUgPSBmaWxlLnNpemU7XG4gICAgdGhpcy5taW1lVHlwZSA9IGZpbGUudHlwZSB8fCAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJztcbiAgICB0aGlzLnN0YXRlQ2hhbmdlID0gb3B0aW9ucy5zdGF0ZUNoYW5nZSB8fCBub29wO1xuICAgIHRoaXMuY29uZmlndXJlKG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIGNvbmZpZ3VyZSBvciByZWNvbmZpZ3VyZSB1cGxvYWRlclxuICAgKi9cbiAgY29uZmlndXJlKGl0ZW0gPSB7fSBhcyBVcGxvYWRJdGVtKTogdm9pZCB7XG4gICAgY29uc3QgeyBtZXRhZGF0YSwgaGVhZGVycywgdG9rZW4sIGVuZHBvaW50IH0gPSBpdGVtO1xuICAgIHRoaXMubWV0YWRhdGEgPSB7XG4gICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICBtaW1lVHlwZTogdGhpcy5taW1lVHlwZSxcbiAgICAgIHNpemU6IHRoaXMuZmlsZS5zaXplLFxuICAgICAgbGFzdE1vZGlmaWVkOiB0aGlzLmZpbGUubGFzdE1vZGlmaWVkLFxuICAgICAgLi4udW5mdW5jKG1ldGFkYXRhIHx8IHRoaXMubWV0YWRhdGEsIHRoaXMuZmlsZSlcbiAgICB9O1xuICAgIHRoaXMuZW5kcG9pbnQgPSBlbmRwb2ludCB8fCB0aGlzLm9wdGlvbnMuZW5kcG9pbnQ7XG4gICAgdGhpcy5jaHVua1NpemUgPSB0aGlzLm9wdGlvbnMuY2h1bmtTaXplIHx8IHRoaXMuY2h1bmtTaXplO1xuICAgIHRoaXMubWF4UmV0cnlBdHRlbXB0cyA9IHRoaXMub3B0aW9ucy5tYXhSZXRyeUF0dGVtcHRzIHx8IHRoaXMubWF4UmV0cnlBdHRlbXB0cztcbiAgICB0aGlzLnJlZnJlc2hUb2tlbih0b2tlbik7XG4gICAgdGhpcy5oZWFkZXJzID0geyAuLi50aGlzLmhlYWRlcnMsIC4uLnVuZnVuYyhoZWFkZXJzLCB0aGlzLmZpbGUpIH07XG4gIH1cblxuICAvKipcbiAgICogRW1pdCBjdXJyZW50IHN0YXRlXG4gICAqL1xuICBwcml2YXRlIG5vdGlmeVN0YXRlKCk6IHZvaWQge1xuICAgIGNvbnN0IHN0YXRlOiBVcGxvYWRTdGF0ZSA9IHtcbiAgICAgIGZpbGU6IHRoaXMuZmlsZSxcbiAgICAgIG5hbWU6IHRoaXMubmFtZSxcbiAgICAgIHByb2dyZXNzOiB0aGlzLnByb2dyZXNzLFxuICAgICAgcGVyY2VudGFnZTogdGhpcy5wcm9ncmVzcyxcbiAgICAgIHJlbWFpbmluZzogdGhpcy5yZW1haW5pbmcsXG4gICAgICByZXNwb25zZTogdGhpcy5yZXNwb25zZSxcbiAgICAgIHJlc3BvbnNlU3RhdHVzOiB0aGlzLnJlc3BvbnNlU3RhdHVzLFxuICAgICAgc2l6ZTogdGhpcy5zaXplLFxuICAgICAgc3BlZWQ6IHRoaXMuc3BlZWQsXG4gICAgICBzdGF0dXM6IHRoaXMuX3N0YXR1cyxcbiAgICAgIHVwbG9hZElkOiB0aGlzLnVwbG9hZElkLFxuICAgICAgVVJJOiB0aGlzLlVSSVxuICAgIH07XG4gICAgdGhpcy5zdGF0ZUNoYW5nZShzdGF0ZSk7XG4gIH1cblxuICBwcml2YXRlIHByb2Nlc3NSZXNwb25zZSh4aHI6IFhNTEh0dHBSZXF1ZXN0KTogdm9pZCB7XG4gICAgdGhpcy5yZXNwb25zZVN0YXR1cyA9IHhoci5zdGF0dXM7XG4gICAgdGhpcy5yZXNwb25zZSA9IHBhcnNlSnNvbih4aHIpO1xuICAgIHRoaXMuc3RhdHVzVHlwZSA9IHhoci5zdGF0dXMgLSAoeGhyLnN0YXR1cyAlIDEwMCk7XG4gIH1cblxuICByZWZyZXNoVG9rZW4odG9rZW4/OiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLnRva2VuID0gdG9rZW4gfHwgdGhpcy50b2tlbjtcbiAgICB0aGlzLl90b2tlbiA9IHVuZnVuYyh0aGlzLnRva2VuKTtcbiAgfVxuXG4gIHByaXZhdGUgbWF4QXR0ZW1wdHNSZWFjaGVkKCk6IGJvb2xlYW4gfCBuZXZlciB7XG4gICAgaWYgKHRoaXMucmV0cnkucmV0cnlBdHRlbXB0cyA9PT0gdGhpcy5tYXhSZXRyeUF0dGVtcHRzICYmIHRoaXMuc3RhdHVzVHlwZSA9PT0gNDAwKSB7XG4gICAgICB0aGlzLnJldHJ5LnJlc2V0KCk7XG4gICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICBgRXJyb3I6IE1heGltdW0gbnVtYmVyIG9mIHJldHJ5IGF0dGVtcHRzIHJlYWNoZWQ6XG4gICAgICAgICAgZmlsZTogJHt0aGlzLm5hbWV9LFxuICAgICAgICAgIHN0YXR1c0NvZGU6ICR7dGhpcy5yZXNwb25zZVN0YXR1c31gXG4gICAgICApO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICghdGhpcy5VUkkgfHwgdGhpcy5yZXNwb25zZVN0YXR1cyA9PT0gNDA0KSB7XG4gICAgICAgIC8vIGdldCBmaWxlIFVSSVxuICAgICAgICBjb25zdCB4aHI6IFhNTEh0dHBSZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICAgIHhoci5vcGVuKHRoaXMub3B0aW9ucy5tZXRob2QudG9VcHBlckNhc2UoKSwgdGhpcy5lbmRwb2ludCwgdHJ1ZSk7XG4gICAgICAgIHRoaXMuc2V0dXBYSFIoeGhyKTtcbiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PVVURi04Jyk7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdYLVVwbG9hZC1Db250ZW50LUxlbmd0aCcsIHRoaXMuc2l6ZS50b1N0cmluZygpKTtcbiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtVXBsb2FkLUNvbnRlbnQtVHlwZScsIHRoaXMubWltZVR5cGUpO1xuICAgICAgICB4aHIub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgIHRoaXMucHJvY2Vzc1Jlc3BvbnNlKHhocik7XG4gICAgICAgICAgY29uc3QgbG9jYXRpb24gPSB0aGlzLnN0YXR1c1R5cGUgPT09IDIwMCAmJiBnZXRLZXlGcm9tUmVzcG9uc2UoeGhyLCAnbG9jYXRpb24nKTtcbiAgICAgICAgICBpZiAoIWxvY2F0aW9uKSB7XG4gICAgICAgICAgICAvLyBsaW1pdCBhdHRlbXB0c1xuICAgICAgICAgICAgdGhpcy5zdGF0dXNUeXBlID0gNDAwO1xuICAgICAgICAgICAgcmVqZWN0KCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuVVJJID0gcmVzb2x2ZVVybChsb2NhdGlvbiwgdGhpcy5lbmRwb2ludCk7XG4gICAgICAgICAgICB0aGlzLnJldHJ5LnJlc2V0KCk7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB4aHIub25lcnJvciA9ICgpID0+IHJlamVjdCgpO1xuICAgICAgICB4aHIuc2VuZChKU09OLnN0cmluZ2lmeSh0aGlzLm1ldGFkYXRhKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhdGUgdXBsb2FkXG4gICAqL1xuICBhc3luYyB1cGxvYWQoaXRlbT86IFVwbG9hZEl0ZW0gfCB1bmRlZmluZWQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoaXRlbSkgdGhpcy5jb25maWd1cmUoaXRlbSk7XG4gICAgaWYgKHRoaXMuX3N0YXR1cyA9PT0gJ2NhbmNlbGxlZCcgfHwgdGhpcy5fc3RhdHVzID09PSAnY29tcGxldGUnIHx8IHRoaXMuX3N0YXR1cyA9PT0gJ3BhdXNlZCcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zdGF0dXMgPSAndXBsb2FkaW5nJztcbiAgICB0aGlzLnJlZnJlc2hUb2tlbigpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmNyZWF0ZSgpO1xuICAgICAgdGhpcy5zdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgIHRoaXMuc2VuZENodW5rKHRoaXMucHJvZ3Jlc3MgPyB1bmRlZmluZWQgOiAwKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAodGhpcy5tYXhBdHRlbXB0c1JlYWNoZWQoKSkge1xuICAgICAgICB0aGlzLnN0YXR1cyA9ICdlcnJvcic7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnN0YXR1cyA9ICdyZXRyeSc7XG4gICAgICAgIGF3YWl0IHRoaXMucmV0cnkud2FpdCh0aGlzLnJlc3BvbnNlU3RhdHVzKTtcbiAgICAgICAgdGhpcy5zdGF0dXMgPSAncXVldWUnO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDaHVuayB1cGxvYWQgKy8gZ2V0IG9mZnNldFxuICAgKi9cbiAgcHJpdmF0ZSBzZW5kQ2h1bmsob2Zmc2V0PzogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuc3RhdHVzID09PSAndXBsb2FkaW5nJykge1xuICAgICAgbGV0IGJvZHkgPSBudWxsO1xuICAgICAgY29uc3QgeGhyOiBYTUxIdHRwUmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgeGhyLm9wZW4oJ1BVVCcsIHRoaXMuVVJJLCB0cnVlKTtcbiAgICAgIHRoaXMuc2V0dXBYSFIoeGhyKTtcbiAgICAgIHRoaXMuc2V0dXBFdmVudHMoeGhyKTtcbiAgICAgIGlmIChvZmZzZXQgPj0gMCAmJiBvZmZzZXQgPCB0aGlzLnNpemUpIHtcbiAgICAgICAgY29uc3QgZW5kID0gdGhpcy5jaHVua1NpemUgPyBNYXRoLm1pbihvZmZzZXQgKyB0aGlzLmNodW5rU2l6ZSwgdGhpcy5zaXplKSA6IHRoaXMuc2l6ZTtcbiAgICAgICAgYm9keSA9IHRoaXMuZmlsZS5zbGljZShvZmZzZXQsIGVuZCk7XG4gICAgICAgIHhoci51cGxvYWQub25wcm9ncmVzcyA9IHRoaXMuc2V0dXBQcm9ncmVzc0V2ZW50KG9mZnNldCwgZW5kKTtcbiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtUmFuZ2UnLCBgYnl0ZXMgJHtvZmZzZXR9LSR7ZW5kIC0gMX0vJHt0aGlzLnNpemV9YCk7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQ29udGVudC1SYW5nZScsIGBieXRlcyAqLyR7dGhpcy5zaXplfWApO1xuICAgICAgfVxuICAgICAgeGhyLnNlbmQoYm9keSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cEV2ZW50cyh4aHI6IFhNTEh0dHBSZXF1ZXN0KTogdm9pZCB7XG4gICAgY29uc3Qgb25FcnJvciA9IGFzeW5jICgpID0+IHtcbiAgICAgIGlmICh0aGlzLm1heEF0dGVtcHRzUmVhY2hlZCgpKSB7XG4gICAgICAgIHRoaXMuc3RhdHVzID0gJ2Vycm9yJztcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5zdGF0dXMgPSAncmV0cnknO1xuICAgICAgYXdhaXQgdGhpcy5yZXRyeS53YWl0KHhoci5zdGF0dXMpO1xuICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDQwNCkge1xuICAgICAgICB0aGlzLnN0YXR1cyA9ICdxdWV1ZSc7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmICh4aHIuc3RhdHVzID09PSA0MTMpIHtcbiAgICAgICAgdGhpcy5jaHVua1NpemUgLz0gMjtcbiAgICAgIH1cbiAgICAgIHRoaXMucmVmcmVzaFRva2VuKCk7XG4gICAgICB0aGlzLnN0YXR1cyA9ICd1cGxvYWRpbmcnO1xuICAgICAgLy8gcmVxdWVzdCBvZmZzZXRcbiAgICAgIHRoaXMuc2VuZENodW5rKCk7XG4gICAgfTtcbiAgICBjb25zdCBvblN1Y2Nlc3MgPSAoKSA9PiB7XG4gICAgICB0aGlzLnByb2Nlc3NSZXNwb25zZSh4aHIpO1xuICAgICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5zdGF0dXNUeXBlID09PSAzMDAgJiYgdGhpcy5nZXROZXh0Q2h1bmtPZmZzZXQoeGhyKTtcbiAgICAgIGlmICh0eXBlb2Ygb2Zmc2V0ID09PSAnbnVtYmVyJykge1xuICAgICAgICAvLyAgbmV4dCBjaHVua1xuICAgICAgICB0aGlzLnJldHJ5LnJlc2V0KCk7XG4gICAgICAgIHRoaXMuc2VuZENodW5rKG9mZnNldCk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdHVzVHlwZSA9PT0gMjAwKSB7XG4gICAgICAgIHRoaXMucHJvZ3Jlc3MgPSAxMDA7XG4gICAgICAgIHRoaXMuc3RhdHVzID0gJ2NvbXBsZXRlJztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9uRXJyb3IoKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHhoci5vbmVycm9yID0gb25FcnJvcjtcbiAgICB4aHIub25sb2FkID0gb25TdWNjZXNzO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cFByb2dyZXNzRXZlbnQob2Zmc2V0OiBudW1iZXIsIGVuZDogbnVtYmVyKSB7XG4gICAgcmV0dXJuIChwRXZlbnQ6IFByb2dyZXNzRXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IHVwbG9hZGVkID0gcEV2ZW50Lmxlbmd0aENvbXB1dGFibGVcbiAgICAgICAgPyBvZmZzZXQgKyAoZW5kIC0gb2Zmc2V0KSAqIChwRXZlbnQubG9hZGVkIC8gcEV2ZW50LnRvdGFsKVxuICAgICAgICA6IG9mZnNldDtcbiAgICAgIHRoaXMucHJvZ3Jlc3MgPSArKCh1cGxvYWRlZCAvIHRoaXMuc2l6ZSkgKiAxMDApLnRvRml4ZWQoMik7XG4gICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgIHRoaXMuc3BlZWQgPSBNYXRoLnJvdW5kKCh1cGxvYWRlZCAvIChub3cgLSB0aGlzLnN0YXJ0VGltZSkpICogMTAwMCk7XG4gICAgICB0aGlzLnJlbWFpbmluZyA9IE1hdGguY2VpbCgodGhpcy5zaXplIC0gdXBsb2FkZWQpIC8gdGhpcy5zcGVlZCk7XG4gICAgICB0aGlzLm5vdGlmeVN0YXRlKCk7XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TmV4dENodW5rT2Zmc2V0KHhocjogWE1MSHR0cFJlcXVlc3QpIHtcbiAgICBjb25zdCBzdHIgPSBnZXRLZXlGcm9tUmVzcG9uc2UoeGhyLCAnUmFuZ2UnKTtcbiAgICBjb25zdCBbbWF0Y2hdID0gc3RyICYmIHN0ci5tYXRjaCgvKC0xfFxcZCspJC9nKTtcbiAgICByZXR1cm4gbWF0Y2ggJiYgK21hdGNoICsgMTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0dXBYSFIoeGhyOiBYTUxIdHRwUmVxdWVzdCkge1xuICAgIC8vcmVzZXQgcmVzcG9uc2VcbiAgICB0aGlzLnJlc3BvbnNlU3RhdHVzID0gbnVsbDtcbiAgICB0aGlzLnJlc3BvbnNlID0gbnVsbDtcbiAgICB0aGlzLnN0YXR1c1R5cGUgPSBudWxsO1xuXG4gICAgdGhpcy5feGhyXyA9IHhocjtcblxuICAgIHhoci5yZXNwb25zZVR5cGUgPSAnanNvbic7XG4gICAgeGhyLndpdGhDcmVkZW50aWFscyA9IHRoaXMub3B0aW9ucy53aXRoQ3JlZGVudGlhbHM7XG4gICAgT2JqZWN0LmtleXModGhpcy5oZWFkZXJzKS5mb3JFYWNoKGtleSA9PiB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHRoaXMuaGVhZGVyc1trZXldKSk7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby11bnVzZWQtZXhwcmVzc2lvblxuICAgIHRoaXMuX3Rva2VuICYmIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdBdXRob3JpemF0aW9uJywgYEJlYXJlciAke3RoaXMuX3Rva2VufWApO1xuICB9XG5cbiAgcmVxdWVzdChtZXRob2Q6IHN0cmluZywgcGF5bG9hZCA9IG51bGwpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgeGhyOiBYTUxIdHRwUmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgeGhyLm9wZW4obWV0aG9kLnRvVXBwZXJDYXNlKCksIHRoaXMuVVJJLCB0cnVlKTtcbiAgICAgIHRoaXMuc2V0dXBYSFIoeGhyKTtcbiAgICAgIHhoci5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMucHJvY2Vzc1Jlc3BvbnNlKHhocik7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH07XG4gICAgICB4aHIub25lcnJvciA9ICgpID0+IHJlamVjdCgpO1xuICAgICAgY29uc3QgYm9keSA9IHBheWxvYWQgPyBKU09OLnN0cmluZ2lmeShwYXlsb2FkKSA6IG51bGw7XG4gICAgICB4aHIuc2VuZChib2R5KTtcbiAgICB9KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRLZXlGcm9tUmVzcG9uc2UoeGhyOiBYTUxIdHRwUmVxdWVzdCwga2V5OiBzdHJpbmcpIHtcbiAgY29uc3QgZnJvbUhlYWRlciA9IHhoci5nZXRSZXNwb25zZUhlYWRlcihrZXkpO1xuICBpZiAoZnJvbUhlYWRlcikge1xuICAgIHJldHVybiBmcm9tSGVhZGVyO1xuICB9XG4gIGNvbnN0IHJlc3BvbnNlID0gcGFyc2VKc29uKHhocikgfHwge307XG4gIGNvbnN0IHJlc0tleSA9IE9iamVjdC5rZXlzKHJlc3BvbnNlKS5maW5kKGsgPT4gay50b0xvd2VyQ2FzZSgpID09PSBrZXkudG9Mb3dlckNhc2UoKSk7XG4gIHJldHVybiByZXNwb25zZVtyZXNLZXldO1xufVxuXG5mdW5jdGlvbiBwYXJzZUpzb24oeGhyOiBYTUxIdHRwUmVxdWVzdCkge1xuICByZXR1cm4gdHlwZW9mIHhoci5yZXNwb25zZSA9PT0gJ29iamVjdCcgPyB4aHIucmVzcG9uc2UgOiBKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQgfHwgbnVsbCk7XG59XG5cbmZ1bmN0aW9uIHVuZnVuYzxUPih2YWx1ZTogVCB8ICgoZmlsZTogRmlsZSkgPT4gVCksIGZpbGU/OiBGaWxlKTogVCB7XG4gIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIEZ1bmN0aW9uID8gdmFsdWUoZmlsZSkgOiB2YWx1ZTtcbn1cbiJdfQ==